import batchSizeDemo from './batchSizeDemo?raw'
import batchOverflowDemo from './batchOverflowDemo?raw'
import batchDelayDemo from './batchDelayDemo?raw'
import flushDemo from './flushDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# createBatch

创建批次处理器，将数据按批次大小或延迟时间聚合后统一回调。

## 详细介绍

`createBatch` 是一个通用的批次聚合工具，用于将频繁产生的零散数据收集到一起，达到阈值或超时后统一处理。

常见应用场景：
- **性能监控上报**：将多条性能指标聚合后批量发送，减少网络请求次数
- **日志收集**：将高频产生的日志聚合后批量写入
- **数据流处理**：将流式数据按批次分组处理，提高吞吐量

批次刷新的触发条件有两个（满足任一即触发）：
1. 批次中的数据量达到 `batchSize` 阈值
2. 距离首条数据添加已超过 `batchDelay` 延迟时间

## 批次大小触发

当添加的数据累计达到 `batchSize` 时，立即触发回调。本例中设置 `batchSize` 为 3，逐条添加数据，当第 3 条添加后批次自动刷新。

<CodeOrSourceMdx language="typescript">
  {batchSizeDemo}
</CodeOrSourceMdx>

## 超过大小立即触发

当一次性添加的数据量超过 `batchSize` 时，立即触发回调。本例中 `batchSize` 为 3，一次性添加 5 条数据，达到阈值后立即刷新。

<CodeOrSourceMdx language="typescript">
  {batchOverflowDemo}
</CodeOrSourceMdx>

## 延迟时间触发

当数据量未达到 `batchSize` 阈值时，在 `batchDelay` 毫秒后自动触发回调。本例设置了一个较大的 `batchSize`（100），添加少量数据后等待 2 秒延迟自动刷新。

<CodeOrSourceMdx language="typescript">
  {batchDelayDemo}
</CodeOrSourceMdx>

## 手动刷新批次

调用 `flush` 可以立即触发回调并清空当前批次，适用于页面卸载、用户离开等需要立即上报的场景。

<CodeOrSourceMdx language="typescript">
  {flushDemo}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>(items: T[]) =&gt; void</code></td>
      <td>批次回调函数，接收当前批次的数据数组</td>
    </tr>
    <tr>
      <td>options.batchSize</td>
      <td><code>number</code></td>
      <td>批次大小阈值，数据量达到此值时立即触发回调</td>
    </tr>
    <tr>
      <td>options.batchDelay</td>
      <td><code>number</code></td>
      <td>批次延迟时间（毫秒），未达到阈值时在此时间后自动触发</td>
    </tr>
  </tbody>
</table>

**返回值 `BatchActions<T>`**

<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>flush</td>
      <td><code>() =&gt; void</code></td>
      <td>手动刷新当前批次，立即触发回调并清空数据</td>
    </tr>
    <tr>
      <td>add</td>
      <td><code>(items: T[]) =&gt; void</code></td>
      <td>添加数据到当前批次</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

**文件职责：**
- `index.ts`：核心实现，创建批次处理器的闭包逻辑
- `interface.ts`：类型定义，`BatchOptions` 配置选项和 `BatchActions` 返回接口

**核心流程：**
1. 初始化内部 `batch` 数组和 `timer` 定时器
2. `add` 方法将数据追加到 `batch`，检查是否达到 `batchSize` 阈值
3. 达到阈值则立即调用 `flush`；否则启动延迟定时器
4. `flush` 方法将 `batch` 副本传入回调，清空数组并取消定时器

**关键技术点：**
- 使用闭包维护 `batch` 和 `timer` 状态
- `flush` 时传入 `[...batch]` 副本，避免回调中修改影响内部状态
- 定时器采用懒创建策略，仅在无活跃定时器时创建新的
