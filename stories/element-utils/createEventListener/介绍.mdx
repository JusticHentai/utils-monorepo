import basicDemo from './basicDemo?raw'
import passiveDemo from './passiveDemo?raw'
import onceDemo from './onceDemo?raw'
import keyboardDemo from './keyboardDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# createEventListener

创建事件监听器，封装原生 addEventListener/removeEventListener，返回清理函数便于管理事件生命周期。

## 详细介绍

createEventListener 是一个事件监听封装函数，核心作用是：**简化事件监听的添加和移除，通过返回清理函数实现声明式的事件管理**。

**涉及的知识点**：
- addEventListener/removeEventListener：原生事件监听 API
- EventTarget 接口：支持 window、document、Element 等
- AddEventListenerOptions：capture、passive、once 等选项

**与直接使用 addEventListener 的区别**：
- 原生方式需要保存 handler 引用才能 removeEventListener
- 本函数返回清理函数，无需保存 handler 引用
- 自动处理非浏览器环境，返回空函数

**常用场景**：
- React/Vue 组件中监听全局事件
- 临时事件监听（如拖拽、手势）
- 需要在特定时机移除的事件
- SSR 环境下的安全事件监听

**优势**：
- API 简洁，返回清理函数
- 自动处理非浏览器环境
- TypeScript 类型安全
- 支持所有原生事件选项

## 基础用法

监听窗口 resize 事件，返回的清理函数可在任意时刻调用以移除监听。

<CodeOrSourceMdx language="typescript">
  {basicDemo}
</CodeOrSourceMdx>

## passive 优化滚动

使用 `passive: true` 选项可以提升滚动性能，告诉浏览器回调中不会调用 `preventDefault()`。

<CodeOrSourceMdx language="typescript">
  {passiveDemo}
</CodeOrSourceMdx>

## 一次性监听

使用 `once: true` 选项，事件只会触发一次后自动移除。

<CodeOrSourceMdx language="typescript">
  {onceDemo}
</CodeOrSourceMdx>

## 键盘事件监听

监听键盘事件，获取按键信息和修饰键状态。

<CodeOrSourceMdx language="typescript">
  {keyboardDemo}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>target</td>
      <td><code>EventTarget | null</code></td>
      <td>事件目标（window、document、Element 等）</td>
    </tr>
    <tr>
      <td>event</td>
      <td><code>string</code></td>
      <td>事件名称（如 'click'、'resize'、'scroll'）</td>
    </tr>
    <tr>
      <td>handler</td>
      <td><code>(event: Event) =&gt; void</code></td>
      <td>事件处理函数</td>
    </tr>
    <tr>
      <td>options</td>
      <td><code>boolean | AddEventListenerOptions</code></td>
      <td>可选，事件选项（capture、passive、once 等）</td>
    </tr>
  </tbody>
</table>

### 返回值

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>CleanupFn</code></td>
      <td>清理函数，调用后移除事件监听</td>
    </tr>
  </tbody>
</table>

### AddEventListenerOptions 说明

<table>
  <thead>
    <tr>
      <th>选项</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>capture</td>
      <td><code>boolean</code></td>
      <td>是否在捕获阶段触发</td>
    </tr>
    <tr>
      <td>passive</td>
      <td><code>boolean</code></td>
      <td>表示回调不会调用 preventDefault()，可提升滚动性能</td>
    </tr>
    <tr>
      <td>once</td>
      <td><code>boolean</code></td>
      <td>事件只触发一次后自动移除</td>
    </tr>
    <tr>
      <td>signal</td>
      <td><code>AbortSignal</code></td>
      <td>AbortController 的 signal，用于批量移除监听</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

### 文件结构

- `index.ts` - 主函数实现
- `interface.ts` - 类型定义（CleanupFn、EventListenerOptions）

### 核心流程

1. 检查是否在浏览器环境（调用 `isBrowser()`）
2. 检查 target 是否为 null
3. 调用 `target.addEventListener()` 添加监听
4. 返回清理函数，内部调用 `removeEventListener()`

### 关键技术点

- 使用 `isBrowser()` 判断环境，非浏览器返回空函数 `() => {}`
- 泛型 `<K extends keyof WindowEventMap>` 提供类型推断
- handler 需要类型断言为 `EventListener` 以兼容原生 API
- 清理函数闭包捕获 target、event、handler、options
