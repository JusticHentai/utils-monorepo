import indexTsx from './index.tsx?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# useMap

管理 Map 类型状态的 Hook。

## 详细介绍

`useMap` 提供了一种便捷的方式来管理 Map 类型的状态，封装了常用的 Map 操作方法。

## 演示代码

<CodeOrSourceMdx language="tsx">
  {indexTsx}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>initialValue</td>
      <td><code>Iterable&lt;readonly [K, T]&gt;</code></td>
      <td>初始值</td>
    </tr>
  </tbody>
</table>

## 返回值

<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>map</td>
      <td><code>Map&lt;K, T&gt;</code></td>
      <td>当前 Map 实例</td>
    </tr>
    <tr>
      <td>set</td>
      <td><code>(key: K, entry: T) =&gt; void</code></td>
      <td>添加/更新元素</td>
    </tr>
    <tr>
      <td>get</td>
      <td><code>(key: K) =&gt; T | undefined</code></td>
      <td>获取元素</td>
    </tr>
    <tr>
      <td>remove</td>
      <td><code>(key: K) =&gt; void</code></td>
      <td>删除元素</td>
    </tr>
    <tr>
      <td>reset</td>
      <td><code>() =&gt; void</code></td>
      <td>重置为初始值</td>
    </tr>
    <tr>
      <td>setAll</td>
      <td><code>(map: Iterable&lt;readonly [K, T]&gt;) =&gt; void</code></td>
      <td>替换整个 Map</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

### 文件职责

- `index.ts`：实现 `useMap` Hook，基于 `useState` 管理 Map 状态，通过 `useMemoizedFn` 提供稳定的操作方法

### 核心流程

1. 通过 `getInitValue` 工厂函数创建初始 Map 实例
2. 使用 `useState` 管理 Map 状态
3. 定义 `set`、`setAll`、`remove`、`reset`、`get` 操作方法
4. 使用 `useMemoizedFn` 包装所有方法，保证引用稳定
5. 返回 `[map, actions] as const` 元组

### 关键技术点

- **不可变更新**：`set` 和 `remove` 操作通过 `new Map(prev)` 创建新实例，确保 React 检测到状态变化
- **`useMemoizedFn`**：包装所有操作方法，避免因引用变化导致消费组件不必要的重渲染
- **`as const`**：返回值使用 `as const` 断言，确保元组类型推断精确

### 数据流向

```
initialValue → getInitValue() → new Map(initialValue)
                                       ↓
                              useState(getInitValue) → [map, setMap]
                                       ↓
                        set/remove → new Map(prev) → setMap(newMap) → 触发重渲染
                        setAll → new Map(newEntries) → setMap(newMap)
                        reset → getInitValue() → setMap(initMap)
                        get → map.get(key)
                                       ↓
                              useMemoizedFn 包装 → 稳定引用
                                       ↓
                              返回 [map, { set, setAll, remove, reset, get }]
```
