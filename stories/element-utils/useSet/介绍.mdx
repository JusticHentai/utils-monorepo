import indexTsx from './index.tsx?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# useSet

管理 Set 类型状态的 Hook。

## 详细介绍

`useSet` 提供了一种便捷的方式来管理 Set 类型的状态，封装了常用的 Set 操作方法。

## 演示代码

<CodeOrSourceMdx language="tsx">
  {indexTsx}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>initialValue</td>
      <td><code>Iterable&lt;K&gt;</code></td>
      <td>初始值</td>
    </tr>
  </tbody>
</table>

## 返回值

<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>set</td>
      <td><code>Set&lt;K&gt;</code></td>
      <td>当前 Set 实例</td>
    </tr>
    <tr>
      <td>add</td>
      <td><code>(key: K) =&gt; void</code></td>
      <td>添加元素</td>
    </tr>
    <tr>
      <td>remove</td>
      <td><code>(key: K) =&gt; void</code></td>
      <td>删除元素</td>
    </tr>
    <tr>
      <td>reset</td>
      <td><code>() =&gt; void</code></td>
      <td>重置为初始值</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

### 文件职责

- `index.ts`：实现 `useSet` Hook，基于 `useState` 管理 Set 状态，通过 `useMemoizedFn` 提供稳定的操作方法

### 核心流程

1. 通过 `getInitValue` 工厂函数创建初始 Set 实例
2. 使用 `useState` 管理 Set 状态
3. 定义通用的 `updateSet` 辅助函数，统一处理不可变更新
4. 定义 `add`、`remove`、`reset` 操作方法
5. 使用 `useMemoizedFn` 包装所有方法，保证引用稳定
6. 返回 `[set, actions] as const` 元组

### 关键技术点

- **不可变更新**：`updateSet` 通过 `new Set(prevSet)` 创建新实例后再执行操作，确保 React 检测到状态变化
- **短路优化**：`add` 和 `remove` 在操作前检查 `set.has(key)`，避免不必要的状态更新和重渲染
- **`useMemoizedFn`**：包装所有操作方法，避免因引用变化导致消费组件不必要的重渲染
- **`as const`**：返回值使用 `as const` 断言，确保元组类型推断精确

### 数据流向

```
initialValue → getInitValue() → new Set(initialValue)
                                       ↓
                              useState(getInitValue) → [set, setSet]
                                       ↓
                        add → has(key)? → 否 → updateSet(newSet.add(key)) → setSet
                        remove → has(key)? → 是 → updateSet(newSet.delete(key)) → setSet
                        reset → getInitValue() → setSet(initSet)
                                       ↓
                              useMemoizedFn 包装 → 稳定引用
                                       ↓
                              返回 [set, { add, remove, reset }]
```
