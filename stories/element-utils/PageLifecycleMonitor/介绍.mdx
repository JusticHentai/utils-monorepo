import basicDemo from './basicDemo?raw'
import customHandlersDemo from './customHandlersDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# PageLifecycleMonitor

页面生命周期事件统一监控器。

## 详细介绍

`PageLifecycleMonitor` 统一监听浏览器页面生命周期的所有关键事件，包括：

- **文档就绪**：DOMContentLoaded、load
- **页面卸载**：beforeunload、unload
- **页面展示/隐藏**：pageshow、pagehide、visibilitychange
- **窗口焦点**：focus、blur
- **网络状态**：online、offline
- **路由变化**：popstate、hashchange
- **页面冻结**：freeze、resume（Page Lifecycle API）
- **SSR 环境检测**

通过构造函数传入自定义处理器覆盖默认行为，未提供处理器的事件使用默认的 `console.info` 日志输出。

## 基础用法

创建 `PageLifecycleMonitor` 实例并传入感兴趣的事件处理器，调用 `observe()` 启动监控，返回停止函数。

<CodeOrSourceMdx language="typescript">
  {basicDemo}
</CodeOrSourceMdx>

## 自定义事件处理器

可以只监听部分事件，如 pageshow/pagehide、网络状态变化、页面冻结/恢复等。

<CodeOrSourceMdx language="typescript">
  {customHandlersDemo}
</CodeOrSourceMdx>

## 参数介绍

### 构造参数 PageLifecycleHandlers

<table>
  <thead>
    <tr>
      <th>事件名</th>
      <th>回调类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DOMContentLoaded</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>DOM 解析完成</td>
    </tr>
    <tr>
      <td>load</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>页面及资源加载完成</td>
    </tr>
    <tr>
      <td>beforeunload</td>
      <td><code>(e?: BeforeUnloadEvent) =&gt; void</code></td>
      <td>页面即将卸载</td>
    </tr>
    <tr>
      <td>unload</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>页面卸载</td>
    </tr>
    <tr>
      <td>pageshow</td>
      <td><code>(e?: PageTransitionEvent) =&gt; void</code></td>
      <td>页面展示（含 BFCache 恢复）</td>
    </tr>
    <tr>
      <td>pagehide</td>
      <td><code>(e?: PageTransitionEvent) =&gt; void</code></td>
      <td>页面隐藏</td>
    </tr>
    <tr>
      <td>visibilitychange</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>页面可见性变化</td>
    </tr>
    <tr>
      <td>focus</td>
      <td><code>(e?: FocusEvent) =&gt; void</code></td>
      <td>窗口获得焦点</td>
    </tr>
    <tr>
      <td>blur</td>
      <td><code>(e?: FocusEvent) =&gt; void</code></td>
      <td>窗口失去焦点</td>
    </tr>
    <tr>
      <td>online</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>网络恢复连接</td>
    </tr>
    <tr>
      <td>offline</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>网络断开连接</td>
    </tr>
    <tr>
      <td>popstate</td>
      <td><code>(e?: PopStateEvent) =&gt; void</code></td>
      <td>浏览器前进/后退</td>
    </tr>
    <tr>
      <td>hashchange</td>
      <td><code>(e?: HashChangeEvent) =&gt; void</code></td>
      <td>URL hash 变化</td>
    </tr>
    <tr>
      <td>freeze</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>页面被冻结</td>
    </tr>
    <tr>
      <td>resume</td>
      <td><code>(e?: Event) =&gt; void</code></td>
      <td>页面从冻结中恢复</td>
    </tr>
    <tr>
      <td>ssr</td>
      <td><code>() =&gt; void</code></td>
      <td>SSR 环境检测</td>
    </tr>
  </tbody>
</table>

### 实例方法

<table>
  <thead>
    <tr>
      <th>方法名</th>
      <th>返回类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>observe()</td>
      <td><code>() =&gt; void</code></td>
      <td>启动监控，返回停止函数</td>
    </tr>
    <tr>
      <td>stop()</td>
      <td><code>void</code></td>
      <td>停止所有监听</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

1. **文件职责**：
   - `index.ts`：PageLifecycleMonitor 类，统一注册所有生命周期事件监听
   - `interface.ts`：事件枚举（PAGE_LIFECYCLE_EVENT）、处理器类型（PageLifecycleHandlers）、默认处理器

2. **核心流程**：
   - 构造函数接收自定义处理器
   - `observe()` 依次调用各个 `onXxx` 工具注册事件监听，收集清理函数
   - 通过 `getHandler(event)` 查找用户处理器或使用默认处理器
   - `stop()` 遍历所有清理函数

3. **关键技术点**：
   - 非浏览器环境（SSR）时触发 `ssr` 处理器并直接返回
   - 网络状态通过 `onNetworkChange` 复用实现，将 `online`/`offline` 映射为布尔值
   - 默认处理器仅打印 `console.info` 日志
