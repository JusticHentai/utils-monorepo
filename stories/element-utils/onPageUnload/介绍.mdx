import pagehideDemo from './pagehideDemo?raw'
import beforeunloadDemo from './beforeunloadDemo?raw'
import cleanupDemo from './cleanupDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# onPageUnload

监听页面卸载事件。

## 详细介绍

`onPageUnload` 用于监听页面即将卸载的事件，可选择使用 `pagehide`（推荐）或 `beforeunload` 事件。

### 底层原理

通过监听 window 的 `pagehide` 或 `beforeunload` 事件来检测页面卸载。`pagehide` 事件在移动端更可靠，且不会阻止 BFCache（后退/前进缓存）。

### 常用场景

- 保存用户未保存的数据
- 清理资源（如 WebSocket 连接）
- 发送统计数据
- 显示确认对话框（仅 beforeunload）

## 使用 pagehide 监听（推荐）

`pagehide` 事件在页面被隐藏时触发，包括用户导航离开或关闭标签页。在移动端比 `beforeunload` 更可靠，且不会阻止浏览器的 BFCache。

<CodeOrSourceMdx language="typescript">
  {pagehideDemo}
</CodeOrSourceMdx>

## 使用 beforeunload 监听

`beforeunload` 事件可以显示确认对话框阻止用户离开，但会阻止 BFCache，影响页面返回时的加载速度。

<CodeOrSourceMdx language="typescript">
  {beforeunloadDemo}
</CodeOrSourceMdx>

## 停止监听

调用返回的清理函数即可停止监听。

<CodeOrSourceMdx language="typescript">
  {cleanupDemo}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>() =&gt; void</code></td>
      <td>卸载回调函数</td>
    </tr>
    <tr>
      <td>useSafeMethod</td>
      <td><code>boolean</code></td>
      <td>是否使用 pagehide（推荐），默认 true</td>
    </tr>
  </tbody>
</table>

## 返回值

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>() =&gt; void</code></td>
      <td>清理函数，调用后停止监听页面卸载事件</td>
    </tr>
  </tbody>
</table>

## pagehide vs beforeunload

<table>
  <thead>
    <tr>
      <th>特性</th>
      <th>pagehide</th>
      <th>beforeunload</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>移动端兼容性</td>
      <td>✅ 更可靠</td>
      <td>⚠️ 可能不触发</td>
    </tr>
    <tr>
      <td>BFCache</td>
      <td>✅ 不阻止</td>
      <td>❌ 会阻止</td>
    </tr>
    <tr>
      <td>确认对话框</td>
      <td>❌ 不支持</td>
      <td>✅ 支持</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

1. **文件职责**：
   - `index.ts`：主函数，根据参数选择监听事件类型
   - `interface.ts`：类型定义

2. **核心流程**：
   - 判断 `useSafeMethod` 参数
   - `true`：使用 `createEventListener` 监听 `pagehide` 事件
   - `false`：使用 `createEventListener` 监听 `beforeunload` 事件
   - 返回清理函数

3. **关键技术点**：
   - 使用 `isBrowser()` 判断运行环境，SSR 安全
   - 统一的事件监听器封装 `createEventListener`
   - 默认使用 `pagehide` 以获得更好的移动端兼容性
