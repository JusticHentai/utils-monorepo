import basicDemo from './basicDemo?raw'
import throttleDemo from './throttleDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# onScroll

监听滚动事件，提供滚动位置和方向信息。

## 详细介绍

`onScroll` 是一个滚动事件监听工具，用于监听窗口（window）或指定 DOM 元素的滚动事件。它封装了原生滚动事件监听，并提供以下增强功能：

- **滚动位置获取**：实时获取水平和垂直滚动位置
- **滚动方向检测**：自动计算滚动方向（上、下、左、右）
- **节流优化**：内置节流功能，避免高频触发影响性能
- **被动事件支持**：自动检测并使用 passive 事件监听，提升滚动性能

**常用场景**：
- 无限滚动加载
- 滚动动画效果
- 返回顶部按钮
- 导航栏显示/隐藏
- 滚动进度条

## 基础用法

监听元素滚动，获取滚动位置和方向：

<CodeOrSourceMdx language="typescript">
  {basicDemo}
</CodeOrSourceMdx>

## 节流监听

使用 throttle 选项减少回调触发频率，优化性能：

<CodeOrSourceMdx language="typescript">
  {throttleDemo}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>target</td>
      <td><code>EventTarget | null</code></td>
      <td>滚动目标，默认为 window</td>
    </tr>
    <tr>
      <td>callback</td>
      <td><code>(params: ScrollParams) =&gt; void</code></td>
      <td>滚动回调函数</td>
    </tr>
    <tr>
      <td>options</td>
      <td><code>OnScrollOptions</code></td>
      <td>配置选项（可选）</td>
    </tr>
  </tbody>
</table>

## OnScrollOptions 配置

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>默认值</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>throttle</td>
      <td><code>number</code></td>
      <td>0</td>
      <td>节流时间（毫秒），0 表示不节流</td>
    </tr>
    <tr>
      <td>immediate</td>
      <td><code>boolean</code></td>
      <td>false</td>
      <td>是否立即执行一次回调</td>
    </tr>
  </tbody>
</table>

## ScrollParams 回调参数

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>x</td>
      <td><code>number</code></td>
      <td>水平滚动位置</td>
    </tr>
    <tr>
      <td>y</td>
      <td><code>number</code></td>
      <td>垂直滚动位置</td>
    </tr>
    <tr>
      <td>direction</td>
      <td><code>ScrollDirection</code></td>
      <td>滚动方向：'up' | 'down' | 'left' | 'right' | 'none'</td>
    </tr>
  </tbody>
</table>

## 返回值

<table>
  <thead>
    <tr>
      <th>返回值</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cleanup</td>
      <td><code>() =&gt; void</code></td>
      <td>清理函数，调用后停止监听滚动事件</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

### 文件职责

- `index.ts`：主入口文件，导出 `onScroll` 函数
- `interface.ts`：类型定义文件，定义 `ScrollParams`、`OnScrollOptions` 等类型

### 核心流程

1. 检查浏览器环境和目标元素有效性
2. 初始化记录上一次滚动位置（lastX, lastY）
3. 定义执行回调函数：获取当前滚动位置 → 计算滚动方向 → 调用用户回调 → 更新上次位置
4. 根据 throttle 配置决定是否包装节流
5. 如果设置 immediate，立即执行一次回调
6. 使用 `createEventListener` 添加滚动事件监听
7. 返回清理函数用于移除监听

### 关键技术点

- **getScrollPosition**：获取目标元素的滚动位置
- **getScrollDirection**：根据位置变化计算滚动方向
- **throttle**：节流函数，控制回调触发频率
- **supportPassiveEvents**：检测是否支持 passive 事件，优化滚动性能
- **createEventListener**：封装事件监听，自动返回清理函数

### 数据流向

```
滚动事件触发 → handler（可能节流）→ executeCallback
  → getScrollPosition（获取位置）
  → getScrollDirection（计算方向）
  → callback（用户回调）
  → 更新 lastX/lastY
```
