import basicDemo from './basicDemo?raw'
import entryTypesDemo from './entryTypesDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# supportPerformanceObserver

检测浏览器是否支持 PerformanceObserver API。PerformanceObserver 用于监听各种性能指标。

## 什么是 PerformanceObserver？

PerformanceObserver 是一个浏览器原生 API，用于异步观察性能度量事件：

```
┌─────────────────────────────────────────────────────────────┐
│                    性能指标时间线                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  导航开始    FP     FCP     LCP          FID    CLS        │
│     │        │       │       │            │      │         │
│     ▼        ▼       ▼       ▼            ▼      ▼         │
│  ───●────────●───────●───────●────────────●──────●────→ 时间 │
│     │        │       │       │            │      │         │
│     │        │       │       │            │      │         │
│     └────────┴───────┴───────┴────────────┴──────┘         │
│                       ↓                                     │
│              PerformanceObserver 收集                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 基础检测

检测当前浏览器是否支持 PerformanceObserver API。

<CodeOrSourceMdx language="typescript">
  {basicDemo}
</CodeOrSourceMdx>

## Entry Types 检测

检测浏览器支持哪些性能指标类型。

<CodeOrSourceMdx language="typescript">
  {entryTypesDemo}
</CodeOrSourceMdx>

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>返回值</td>
      <td><code>boolean</code></td>
      <td>是否支持 PerformanceObserver API</td>
    </tr>
  </tbody>
</table>

## 导出的其他函数

<table>
  <thead>
    <tr>
      <th>函数名</th>
      <th>返回类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>getSupportedEntryTypes</td>
      <td><code>string[]</code></td>
      <td>获取浏览器支持的所有 entry types</td>
    </tr>
    <tr>
      <td>supportEntryType</td>
      <td><code>boolean</code></td>
      <td>检测是否支持指定的 entry type</td>
    </tr>
  </tbody>
</table>

## 常用 Entry Types

<table>
  <thead>
    <tr>
      <th>Entry Type</th>
      <th>用途</th>
      <th>对应指标</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>paint</td>
      <td>绘制事件</td>
      <td>FP, FCP</td>
    </tr>
    <tr>
      <td>largest-contentful-paint</td>
      <td>最大内容绘制</td>
      <td>LCP</td>
    </tr>
    <tr>
      <td>first-input</td>
      <td>首次输入延迟</td>
      <td>FID</td>
    </tr>
    <tr>
      <td>layout-shift</td>
      <td>布局偏移</td>
      <td>CLS</td>
    </tr>
    <tr>
      <td>longtask</td>
      <td>长任务</td>
      <td>TBT</td>
    </tr>
    <tr>
      <td>resource</td>
      <td>资源加载</td>
      <td>资源加载时间</td>
    </tr>
    <tr>
      <td>navigation</td>
      <td>页面导航</td>
      <td>TTFB, DOM 解析时间</td>
    </tr>
  </tbody>
</table>

## 原生 API 用法

```typescript
// 创建观察器
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach(entry => {
    console.log(`${entry.name}: ${entry.startTime}ms`)
  })
})

// 观察特定类型
observer.observe({ 
  type: 'largest-contentful-paint',
  buffered: true  // 获取页面加载前已发生的条目
})

// 观察多个类型
observer.observe({ 
  entryTypes: ['paint', 'longtask', 'resource'] 
})

// 停止观察
observer.disconnect()
```

## Core Web Vitals 监控示例

```typescript
import supportPerformanceObserver, { 
  supportEntryType 
} from '@justichentai/element-utils/supportPerformanceObserver'

if (supportPerformanceObserver()) {
  // LCP - 最大内容绘制
  if (supportEntryType('largest-contentful-paint')) {
    new PerformanceObserver((list) => {
      const entries = list.getEntries()
      const lcp = entries[entries.length - 1]
      console.log('LCP:', lcp.startTime)
    }).observe({ type: 'largest-contentful-paint', buffered: true })
  }

  // FID - 首次输入延迟
  if (supportEntryType('first-input')) {
    new PerformanceObserver((list) => {
      const fid = list.getEntries()[0]
      console.log('FID:', fid.processingStart - fid.startTime)
    }).observe({ type: 'first-input', buffered: true })
  }
}
```

## 浏览器兼容性

<table>
  <thead>
    <tr>
      <th>浏览器</th>
      <th>支持版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Chrome</td>
      <td>52+</td>
    </tr>
    <tr>
      <td>Firefox</td>
      <td>57+</td>
    </tr>
    <tr>
      <td>Safari</td>
      <td>11+</td>
    </tr>
    <tr>
      <td>Edge</td>
      <td>79+</td>
    </tr>
    <tr>
      <td>IE</td>
      <td>❌ 不支持</td>
    </tr>
  </tbody>
</table>

## 检测原理

```typescript
import isBrowser from '../isBrowser'

const supportPerformanceObserver = (): boolean => {
  return isBrowser() && 'PerformanceObserver' in window
}

export const getSupportedEntryTypes = (): string[] => {
  if (!supportPerformanceObserver()) return []
  return PerformanceObserver.supportedEntryTypes || []
}

export const supportEntryType = (type: string): boolean => {
  return getSupportedEntryTypes().includes(type)
}
```

通过检测 `window.PerformanceObserver` 是否存在来判断浏览器支持情况，并使用 `supportedEntryTypes` 静态属性检测具体的 entry type 支持。
