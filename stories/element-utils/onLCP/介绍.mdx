import initBasicDemo from './initBasicDemo?raw'
import initAllChangesDemo from './initAllChangesDemo?raw'
import initMetricDemo from './initMetricDemo?raw'
import cleanupDemo from './cleanupDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# onLCP

监听 LCP (Largest Contentful Paint)。LCP 是最大内容绘制时间，衡量页面主要内容的加载速度。

## 详细介绍

`onLCP` 是基于 `PerformanceObserver` 封装的 LCP 性能指标监听工具。

**涉及的知识点**：
- LCP 指标：Core Web Vitals 三大核心指标之一
- PerformanceObserver API：监听 largest-contentful-paint 类型
- 页面可见性：通常在页面隐藏时报告最终 LCP

**LCP 评分标准**：
- 好：≤ 2.5 秒
- 需要改进：2.5 - 4 秒
- 差：> 4 秒

**常用场景**：
- 性能监控：收集用户真实 LCP 数据
- 性能优化：识别影响 LCP 的元素
- A/B 测试：对比不同版本的 LCP 表现

**优势**：
- 自动追踪 LCP 候选元素变化
- 支持选择报告最终值或所有变化
- 页面隐藏时自动报告

## 监听 LCP（最终值）

监听 LCP 指标，仅在页面隐藏时报告最终的 LCP 值。这是默认模式，适合生产环境收集用户真实体验数据。

<CodeOrSourceMdx language="typescript">
  {initBasicDemo}
</CodeOrSourceMdx>

## 监听 LCP（所有变化）

设置 `reportAllChanges` 为 `true`，每次 LCP 候选元素变化时都会触发回调。适合开发调试阶段观察 LCP 的变化过程。

<CodeOrSourceMdx language="typescript">
  {initAllChangesDemo}
</CodeOrSourceMdx>

## 监听 LCP（Metric 版本）

使用 `onLCPMetric` 获取完整的 Metric 对象，包含 rating、delta、id、navigationType 等信息。适合需要完整性能数据的场景。

<CodeOrSourceMdx language="typescript">
  {initMetricDemo}
</CodeOrSourceMdx>

## 清理监听

调用返回的清理函数停止 LCP 监听，释放资源。

<CodeOrSourceMdx language="typescript">
  {cleanupDemo}
</CodeOrSourceMdx>

## 参数介绍

### onLCP

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>OnLCPCallback</code></td>
      <td>LCP 回调函数，参数为 LargestContentfulPaint</td>
    </tr>
    <tr>
      <td>reportAllChanges</td>
      <td><code>boolean</code></td>
      <td>可选，是否报告所有变化，默认为 false</td>
    </tr>
  </tbody>
</table>

### onLCPMetric

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>OnLCPMetricCallback</code></td>
      <td>LCP 回调函数，参数为完整的 LCPMetric 对象</td>
    </tr>
    <tr>
      <td>options</td>
      <td><code>OnLCPMetricOptions</code></td>
      <td>可选配置，包含 reportAllChanges</td>
    </tr>
  </tbody>
</table>

### LCPMetric 类型

<table>
  <thead>
    <tr>
      <th>属性名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td><code>MetricName.LCP</code></td>
      <td>指标名称</td>
    </tr>
    <tr>
      <td>value</td>
      <td><code>number</code></td>
      <td>指标值（毫秒）</td>
    </tr>
    <tr>
      <td>rating</td>
      <td><code>MetricRating</code></td>
      <td>指标评级（good / needs-improvement / poor）</td>
    </tr>
    <tr>
      <td>delta</td>
      <td><code>number</code></td>
      <td>与上次值的差值</td>
    </tr>
    <tr>
      <td>id</td>
      <td><code>string</code></td>
      <td>唯一标识符</td>
    </tr>
    <tr>
      <td>navigationType</td>
      <td><code>NAVIGATION_TYPE</code></td>
      <td>导航类型</td>
    </tr>
    <tr>
      <td>entries</td>
      <td><code>LargestContentfulPaint[]</code></td>
      <td>相关的性能条目</td>
    </tr>
  </tbody>
</table>

### 返回值

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>() =&gt; void</code></td>
      <td>清理函数，调用后停止观察</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

### 文件结构

- `index.ts` - 主函数实现，包含 onLCP 和 onLCPMetric
- `interface.ts` - 类型定义，包含 LCPMetric 接口

### 核心流程

1. 使用 `createPerformanceObserver` 监听 `largest-contentful-paint`
2. 记录最后一个 LCP 候选条目
3. 根据 `reportAllChanges` 决定是否立即报告
4. 监听 `visibilitychange` 事件，页面隐藏时报告最终值
5. `onLCPMetric` 封装 `onLCP`，添加 rating、delta 等完整信息

### 关键技术点

- LCP 可能多次更新，最后一个才是最终值
- 使用 visibilitychange 事件捕获页面隐藏时机
- 支持两种报告模式：最终值或所有变化
- Metric 版本自动计算评级和增量
