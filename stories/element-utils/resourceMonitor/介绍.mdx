import observeDemo from './observeDemo?raw'
import stopObserveDemo from './stopObserveDemo?raw'
import getMetricsDemo from './getMetricsDemo?raw'
import getStatsDemo from './getStatsDemo?raw'
import getSlowResourcesDemo from './getSlowResourcesDemo?raw'
import getLargeResourcesDemo from './getLargeResourcesDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# ResourceMonitor

基于 `PerformanceObserver` API 的页面资源加载监控类，通过实例化后调用方法完成资源监控和分析。

## 详细介绍

ResourceMonitor 封装了浏览器 Performance API，提供资源加载的实时监听和历史查询能力。底层使用 `PerformanceObserver` 监听 `resource` 类型条目，结合 `createBatch` 实现批量聚合上报，避免高频回调。

适用场景：
- 前端性能监控系统中的资源加载数据采集
- 页面性能分析，定位慢资源和大资源
- 资源加载统计和缓存命中率分析

核心优势：
- 实例化时传入 `filter`，后续所有操作自动应用，无需重复传参
- 查询方法（`getStats`、`getSlowResources`、`getLargeResources`）基于 `getMetrics` 结果二次处理，避免重复查询
- `observe` 内置批量聚合和页面卸载时自动 flush

## 开始监听资源加载

通过 `observe` 方法启动实时监控，基于 `PerformanceObserver` 监听新加载的资源。内部使用 `createBatch` 将资源条目批量聚合后回调，默认攒满 10 条或延迟 1 秒触发。返回停止函数用于清理。

<CodeOrSourceMdx language="typescript">
  {observeDemo}
</CodeOrSourceMdx>

## 停止监听

调用 `observe` 返回的函数停止监听，会自动 flush 剩余批次、断开 observer、移除 pagehide 事件。

<CodeOrSourceMdx language="typescript">
  {stopObserveDemo}
</CodeOrSourceMdx>

## 获取资源指标

通过 `getMetrics` 一次性获取当前页面所有已加载资源的性能数据快照。底层调用 `performance.getEntriesByType('resource')` 并通过 `parseResourceEntry` 解析为结构化的 `ResourceMetrics` 对象，包含 DNS、TCP、TLS、TTFB、下载耗时等细分指标。

<CodeOrSourceMdx language="typescript">
  {getMetricsDemo}
</CodeOrSourceMdx>

## 获取资源统计

通过 `getStats` 获取资源的聚合统计信息，包括总数、缓存数、总大小、总耗时，以及按 `initiatorType`（script/img/fetch 等）分组的明细。

<CodeOrSourceMdx language="typescript">
  {getStatsDemo}
</CodeOrSourceMdx>

## 获取慢资源

通过 `getSlowResources` 筛选 `duration` 超过指定阈值的资源，用于定位加载缓慢的请求。默认阈值 1000ms，demo 中使用 100ms 以便在 Storybook 环境中看到结果。

<CodeOrSourceMdx language="typescript">
  {getSlowResourcesDemo}
</CodeOrSourceMdx>

## 获取大资源

通过 `getLargeResources` 筛选 `transferSize` 超过指定阈值的资源，用于发现体积过大的文件。默认阈值 500KB，demo 中使用 50KB。

<CodeOrSourceMdx language="typescript">
  {getLargeResourcesDemo}
</CodeOrSourceMdx>

## 参数介绍

### 构造函数

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>options</td>
      <td><code>ResourceMonitorOptions</code></td>
      <td>可选配置</td>
    </tr>
    <tr>
      <td>options.filter</td>
      <td><code>ResourceFilter</code></td>
      <td>资源过滤函数，实例级别生效</td>
    </tr>
  </tbody>
</table>

### observe 方法

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>ResourceCallback</code></td>
      <td>资源加载回调函数</td>
    </tr>
    <tr>
      <td>options</td>
      <td><code>ResourceMonitorOptions</code></td>
      <td>可选配置，可覆盖实例级配置</td>
    </tr>
    <tr>
      <td>options.reportExisting</td>
      <td><code>boolean</code></td>
      <td>是否上报已存在的资源，默认 true</td>
    </tr>
    <tr>
      <td>options.batchSize</td>
      <td><code>number</code></td>
      <td>批量大小，默认 10</td>
    </tr>
    <tr>
      <td>options.batchDelay</td>
      <td><code>number</code></td>
      <td>批量延迟（ms），默认 1000</td>
    </tr>
  </tbody>
</table>

### 返回值

<table>
  <thead>
    <tr>
      <th>方法</th>
      <th>返回类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>getMetrics()</td>
      <td><code>ResourceMetrics[]</code></td>
      <td>所有已加载资源的性能指标</td>
    </tr>
    <tr>
      <td>getStats()</td>
      <td><code>ResourceStats</code></td>
      <td>资源统计信息</td>
    </tr>
    <tr>
      <td>getSlowResources(threshold?)</td>
      <td><code>ResourceMetrics[]</code></td>
      <td>慢资源列表，threshold 默认 1000ms</td>
    </tr>
    <tr>
      <td>getLargeResources(threshold?)</td>
      <td><code>ResourceMetrics[]</code></td>
      <td>大资源列表，threshold 默认 500KB</td>
    </tr>
    <tr>
      <td>observe(callback, options?)</td>
      <td><code>() =&gt; void</code></td>
      <td>停止监听函数</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

**文件职责：**
- `index.ts`：ResourceMonitor 类，持有实例级 filter，组装各 core 方法
- `core/observeResource.ts`：observe 核心实现，串联 createBatch + createPerformanceObserver + createEventListener
- `core/getResourceMetrics.ts`：通过 performance.getEntriesByType 查询并解析资源条目
- `core/getResourceStats.ts`：遍历资源数据生成聚合统计
- `core/getSlowResources.ts`：按 duration 阈值过滤
- `core/getLargeResources.ts`：按 transferSize 阈值过滤
- `core/parseResourceEntry.ts`：将 PerformanceResourceTiming 解析为 ResourceMetrics

**核心流程：**
1. 实例化时存储 filter 配置
2. `observe` 调用时，先通过 `getResourceMetrics` 上报已有资源，再通过 `createPerformanceObserver` 监听增量
3. 增量资源通过 `createBatch` 聚合，达到 batchSize 或 batchDelay 后批量回调
4. 页面 pagehide 时通过 `createEventListener` 注册的监听自动 flush 剩余批次
5. 查询方法（getStats/getSlowResources/getLargeResources）基于 getMetrics 的结果二次处理

**关键技术点：**
- `PerformanceObserver` API 监听 resource 类型条目
- `createBatch` 批量聚合避免高频回调
- `parseResourceEntry` 从原生 timing 数据计算 DNS/TCP/TLS/TTFB/下载等细分耗时
- 通过 `transferSize === 0` 判断缓存命中
