import basicDemo from './basicDemo?raw'
import networkInfoDemo from './networkInfoDemo?raw'
import memoryInfoDemo from './memoryInfoDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# getPageInfo

获取当前页面的完整信息，包含 URL、设备、屏幕、网络和内存等数据。

## 详细介绍

`getPageInfo` 是一个用于收集页面环境信息的工具函数，为前端监控和数据分析提供基础数据。

**核心功能：**
- 收集页面基础信息（URL、标题、来源页面）
- 收集设备信息（UserAgent、平台、语言、时区）
- 收集屏幕信息（分辨率、视口大小、设备像素比）
- 收集网络信息（连接类型、有效连接类型）
- 收集内存信息（JS 堆大小限制、使用情况）

**应用场景：**
- 前端错误监控：上报错误时附带页面环境信息
- 用户行为分析：了解用户设备和网络情况
- 性能监控：结合内存信息分析内存泄漏
- A/B 测试：基于设备特征进行用户分组

## 获取基础页面信息

获取页面 URL、标题、设备和屏幕等基础信息。

<CodeOrSourceMdx language="typescript">
  {basicDemo}
</CodeOrSourceMdx>

## 获取网络信息

获取用户的网络连接类型，注意此 API 在部分浏览器中不可用。

<CodeOrSourceMdx language="typescript">
  {networkInfoDemo}
</CodeOrSourceMdx>

## 获取内存信息

获取 JavaScript 堆内存使用情况，可用于检测内存泄漏。

<CodeOrSourceMdx language="typescript">
  {memoryInfoDemo}
</CodeOrSourceMdx>

### V8 内存字段说明

**字段关系：**

`usedJSHeapSize`（已用） ≤ `totalJSHeapSize`（总） ≤ `jsHeapSizeLimit`（限制）

**各字段含义：**

<table>
  <thead>
    <tr>
      <th>字段</th>
      <th>含义</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>usedJSHeapSize</code></td>
      <td>已用堆大小</td>
      <td>当前真正被 JS 对象占用的堆内存（活跃对象 + 还没被回收但暂时保留的对象）</td>
    </tr>
    <tr>
      <td><code>totalJSHeapSize</code></td>
      <td>已分配堆大小</td>
      <td>V8 当前已向系统申请/保留的 JS 堆总量，包含已用、空闲区、预留空间和碎片</td>
    </tr>
    <tr>
      <td><code>jsHeapSizeLimit</code></td>
      <td>堆大小限制</td>
      <td>JS 堆的最大可用内存限制</td>
    </tr>
  </tbody>
</table>

**为什么 `total` 可能明显大于 `used`：**

- **加速分配**：V8 往往会提前扩堆，留出余量，避免频繁向 OS 申请内存
- **GC 后不立刻缩回**：即使已用下降，V8 可能暂时保留已申请的堆，后续再用
- **碎片化**：有些空洞空间不容易立刻复用或归还，导致 total 看起来偏大

公式表示：`totalJSHeapSize ≈ usedJSHeapSize + free/unused + fragmentation`

**注意事项：**

- 这些值来自浏览器的 `performance.memory`，**仅 Chrome 系浏览器支持**
- Firefox、Safari 等浏览器不支持此 API
- 数值可能因实现而有偏差，仅供参考
- Chrome 需启动时添加 `--enable-precise-memory-info` 标志才能获取精确值

## 参数介绍

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>（无参数）</td>
      <td>-</td>
      <td>-</td>
    </tr>
    <tr>
      <td>返回值</td>
      <td><code>PageInfo</code></td>
      <td>页面信息对象</td>
    </tr>
  </tbody>
</table>

### PageInfo 结构

<table>
  <thead>
    <tr>
      <th>字段</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>url</td>
      <td><code>string</code></td>
      <td>当前页面 URL</td>
    </tr>
    <tr>
      <td>title</td>
      <td><code>string</code></td>
      <td>页面标题</td>
    </tr>
    <tr>
      <td>referrer</td>
      <td><code>string</code></td>
      <td>来源页面 URL</td>
    </tr>
    <tr>
      <td>userAgent</td>
      <td><code>string</code></td>
      <td>用户代理字符串</td>
    </tr>
    <tr>
      <td>screenResolution</td>
      <td><code>string</code></td>
      <td>屏幕分辨率（如 "1920x1080"）</td>
    </tr>
    <tr>
      <td>viewport</td>
      <td><code>string</code></td>
      <td>视口大小（如 "1200x800"）</td>
    </tr>
    <tr>
      <td>devicePixelRatio</td>
      <td><code>number</code></td>
      <td>设备像素比</td>
    </tr>
    <tr>
      <td>language</td>
      <td><code>string</code></td>
      <td>浏览器语言</td>
    </tr>
    <tr>
      <td>platform</td>
      <td><code>string</code></td>
      <td>操作系统平台</td>
    </tr>
    <tr>
      <td>timezone</td>
      <td><code>string</code></td>
      <td>时区</td>
    </tr>
    <tr>
      <td>networkType?</td>
      <td><code>string</code></td>
      <td>网络连接类型（可选）</td>
    </tr>
    <tr>
      <td>effectiveType?</td>
      <td><code>string</code></td>
      <td>有效连接类型（可选）</td>
    </tr>
    <tr>
      <td>memory?</td>
      <td><code>MemoryInfo</code></td>
      <td>内存信息（可选）</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

**文件职责：**
- `index.ts`: 主函数，收集各类页面信息
- `interface.ts`: PageInfo 和 MemoryInfo 类型定义

**核心流程：**
1. 检查是否在浏览器环境，SSR 环境返回空值对象
2. 从 `window`、`navigator`、`screen`、`document`、`location` 收集信息
3. 检查 `navigator.connection` 是否存在，存在则收集网络信息
4. 检查 `performance.memory` 是否存在，存在则收集内存信息
5. 返回完整的 PageInfo 对象

**关键技术点：**
- 使用 Network Information API 获取网络信息（部分浏览器支持）
- 使用 Performance Memory API 获取内存信息（Chrome 系浏览器支持）
- 使用 `Intl.DateTimeFormat` 获取用户时区
- SSR 兼容处理，返回安全的默认值
