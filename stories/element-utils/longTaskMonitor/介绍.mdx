import startObserveDemo from './startObserveDemo?raw'
import stopObserveDemo from './stopObserveDemo?raw'
import triggerLongTaskDemo from './triggerLongTaskDemo?raw'
import getStatsDemo from './getStatsDemo?raw'
import calculateTBTDemo from './calculateTBTDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# createLongTaskObserver

创建长任务观察器实例，用于监控阻塞主线程超过 50ms 的任务。

## 详细介绍

**长任务 (Long Task)** 是指在主线程上执行时间超过 50ms 的任务。这类任务会阻塞用户交互，导致页面卡顿、响应延迟等问题。

该工具基于 [Long Tasks API](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceLongTaskTiming) 实现，提供以下能力：

- **实时监控**：通过 PerformanceObserver 实时捕获长任务
- **统计分析**：自动统计长任务数量、总时长、最大时长、平均时长
- **TBT 计算**：计算总阻塞时间 (Total Blocking Time)，是 Web Vitals 重要指标之一

**使用场景**：
- 性能监控和优化
- 识别页面卡顿原因
- Core Web Vitals 指标收集
- 用户体验分析

## 开始监听长任务

创建观察器实例并开始监听，每当检测到长任务时触发回调。

<CodeOrSourceMdx language="typescript">
  {startObserveDemo}
</CodeOrSourceMdx>

## 停止监听

停止监听并清理资源，可以获取最终的统计信息。

<CodeOrSourceMdx language="typescript">
  {stopObserveDemo}
</CodeOrSourceMdx>

## 触发长任务

通过阻塞主线程来模拟长任务，用于测试监听功能。

<CodeOrSourceMdx language="typescript">
  {triggerLongTaskDemo}
</CodeOrSourceMdx>

## 获取统计信息

获取所有记录的长任务统计数据，包括数量、时长等信息。

<CodeOrSourceMdx language="typescript">
  {getStatsDemo}
</CodeOrSourceMdx>

## 计算 TBT

TBT (Total Blocking Time) 是 FCP 到 TTI 之间所有长任务阻塞部分的总和，是衡量页面交互性的重要指标。

<CodeOrSourceMdx language="typescript">
  {calculateTBTDemo}
</CodeOrSourceMdx>

## 参数介绍

### createLongTaskObserver

<table>
  <thead>
    <tr>
      <th>返回值</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>observer</td>
      <td><code>LongTaskObserverInstance</code></td>
      <td>长任务观察器实例</td>
    </tr>
  </tbody>
</table>

### observer.observe(callback?, options?)

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>callback</td>
      <td><code>(task: LongTaskMetrics) =&gt; void</code></td>
      <td>可选，检测到长任务时的回调函数</td>
    </tr>
    <tr>
      <td>options.threshold</td>
      <td><code>number</code></td>
      <td>可选，持续时间阈值（ms），默认 50ms</td>
    </tr>
    <tr>
      <td>options.reportExisting</td>
      <td><code>boolean</code></td>
      <td>可选，是否上报已存在的长任务，默认 true</td>
    </tr>
  </tbody>
</table>

### observer.calculateTBT(fcpTime?, ttiTime?)

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>fcpTime</td>
      <td><code>number</code></td>
      <td>可选，FCP 时间点，默认 0</td>
    </tr>
    <tr>
      <td>ttiTime</td>
      <td><code>number</code></td>
      <td>可选，TTI 时间点，默认 performance.now()</td>
    </tr>
  </tbody>
</table>

### LongTaskMetrics

<table>
  <thead>
    <tr>
      <th>属性名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td><code>string</code></td>
      <td>任务名称</td>
    </tr>
    <tr>
      <td>startTime</td>
      <td><code>number</code></td>
      <td>任务开始时间（相对于 navigationStart）</td>
    </tr>
    <tr>
      <td>duration</td>
      <td><code>number</code></td>
      <td>任务持续时间（ms）</td>
    </tr>
    <tr>
      <td>attribution</td>
      <td><code>TaskAttribution[]</code></td>
      <td>任务归因信息（来源容器等）</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

**文件职责**：
- `index.ts`：核心实现，包含观察器创建、监听、统计和 TBT 计算逻辑
- `interface.ts`：类型定义，包含长任务指标、统计结果、配置选项等接口

**核心流程**：
1. 调用 `createLongTaskObserver()` 创建观察器实例
2. 调用 `observe()` 通过 PerformanceObserver 监听 `longtask` 类型条目
3. 检测到长任务时解析条目信息，存入内部缓存并触发回调
4. 调用 `getStats()` 或 `calculateTBT()` 获取统计数据

**关键技术点**：
- 使用 `PerformanceObserver` API 监听 `longtask` 类型
- 长任务阈值默认 50ms（W3C 标准定义）
- TBT 计算公式：`Σ(duration - 50ms)`，只计算超出 50ms 的部分
- 支持从 `performance.getEntriesByType()` 获取历史长任务

**数据流向**：
```
PerformanceObserver → parseLongTaskEntry → longTaskEntries[] → getStats/calculateTBT
```
