import observeAllDemo from './observeAllDemo?raw'
import stopDemo from './stopDemo?raw'
import sendXHRDemo from './sendXHRDemo?raw'
import sendFetchDemo from './sendFetchDemo?raw'
import getStatsDemo from './getStatsDemo?raw'
import clearDemo from './clearDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# RequestMonitor

网络请求监控器，用于拦截和记录页面中的 XMLHttpRequest 和 Fetch 请求。

## 详细介绍

`RequestMonitor` 是一个基于 Class 的网络请求监控工具，通过代理 `XMLHttpRequest.prototype` 和 `window.fetch` 来拦截所有网络请求。

核心能力包括：
- 分别或同时监控 XHR 和 Fetch 请求
- 记录请求的 URL、方法、状态码、耗时、响应大小等信息
- 自动统计成功/失败/慢请求数量
- 支持 URL 忽略规则（字符串或正则）
- 错误和超时的回调通知

常用于前端性能监控、错误上报、请求日志采集等场景。通过拦截原生 API 实现零侵入式监控，无需修改业务代码。

## 开启监控

创建 `RequestMonitor` 实例并调用 `observeAll()` 同时监控 XHR 和 Fetch。也可以单独调用 `observeXHR()` 或 `observeFetch()` 按需监控。

<CodeOrSourceMdx language="typescript">
  {observeAllDemo}
</CodeOrSourceMdx>

## 停止监控

调用 `stop()` 方法会还原被代理的原生 API，停止所有监控。

<CodeOrSourceMdx language="typescript">
  {stopDemo}
</CodeOrSourceMdx>

## 发送 XHR 请求

在监控开启后发送 XHR 请求，`onRequest` 回调会自动触发并记录请求信息。

<CodeOrSourceMdx language="typescript">
  {sendXHRDemo}
</CodeOrSourceMdx>

## 发送 Fetch 请求

在监控开启后发送 Fetch 请求，同样会被拦截并记录。

<CodeOrSourceMdx language="typescript">
  {sendFetchDemo}
</CodeOrSourceMdx>

## 查看统计信息

通过 `getStats()` 获取请求统计（总数、成功/失败数、平均耗时、慢请求数、按状态码分布），通过 `getRequests()` 获取所有请求记录。

<CodeOrSourceMdx language="typescript">
  {getStatsDemo}
</CodeOrSourceMdx>

## 清空记录

调用 `clear()` 清空已记录的请求数据，统计信息归零。

<CodeOrSourceMdx language="typescript">
  {clearDemo}
</CodeOrSourceMdx>

## 参数介绍

### 构造参数 `RequestMonitorOptions`

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>onRequest</td>
      <td><code>(request: RequestInfo) =&gt; void</code></td>
      <td>请求完成时的回调</td>
    </tr>
    <tr>
      <td>onError</td>
      <td><code>(error: RequestErrorInfo) =&gt; void</code></td>
      <td>请求错误时的回调（可选）</td>
    </tr>
    <tr>
      <td>ignoreUrls</td>
      <td><code>(string | RegExp)[]</code></td>
      <td>忽略的 URL 列表（可选）</td>
    </tr>
    <tr>
      <td>timeoutThreshold</td>
      <td><code>number</code></td>
      <td>超时阈值，单位 ms，默认 30000（可选）</td>
    </tr>
  </tbody>
</table>

### 实例方法

<table>
  <thead>
    <tr>
      <th>方法</th>
      <th>返回类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>observeXHR()</td>
      <td><code>() =&gt; void</code></td>
      <td>监控 XMLHttpRequest，返回停止函数</td>
    </tr>
    <tr>
      <td>observeFetch()</td>
      <td><code>() =&gt; void</code></td>
      <td>监控 Fetch，返回停止函数</td>
    </tr>
    <tr>
      <td>observeAll()</td>
      <td><code>() =&gt; void</code></td>
      <td>同时监控 XHR + Fetch，返回停止函数</td>
    </tr>
    <tr>
      <td>getStats()</td>
      <td><code>RequestStats</code></td>
      <td>获取请求统计信息</td>
    </tr>
    <tr>
      <td>getRequests()</td>
      <td><code>RequestInfo[]</code></td>
      <td>获取所有请求记录</td>
    </tr>
    <tr>
      <td>clear()</td>
      <td><code>void</code></td>
      <td>清空请求记录</td>
    </tr>
    <tr>
      <td>stop()</td>
      <td><code>void</code></td>
      <td>停止所有监控，还原原生 API</td>
    </tr>
  </tbody>
</table>

### RequestStats 返回类型

<table>
  <thead>
    <tr>
      <th>字段</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>total</td>
      <td><code>number</code></td>
      <td>总请求数</td>
    </tr>
    <tr>
      <td>success</td>
      <td><code>number</code></td>
      <td>成功请求数</td>
    </tr>
    <tr>
      <td>failed</td>
      <td><code>number</code></td>
      <td>失败请求数</td>
    </tr>
    <tr>
      <td>totalDuration</td>
      <td><code>number</code></td>
      <td>总耗时 (ms)</td>
    </tr>
    <tr>
      <td>avgDuration</td>
      <td><code>number</code></td>
      <td>平均耗时 (ms)</td>
    </tr>
    <tr>
      <td>slowRequests</td>
      <td><code>number</code></td>
      <td>慢请求数（&gt;3s）</td>
    </tr>
    <tr>
      <td>byStatus</td>
      <td><code>Record&lt;number, number&gt;</code></td>
      <td>按状态码统计</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

1. **文件职责**:
   - `index.ts` — `RequestMonitor` Class，管理监控生命周期、请求记录和统计
   - `interface.ts` — 类型定义（RequestInfo、RequestErrorInfo、RequestMonitorOptions 等）
   - `core/observeXHR.ts` — 代理 `XMLHttpRequest.prototype.open/send/setRequestHeader` 拦截 XHR 请求
   - `core/observeFetch.ts` — 代理 `window.fetch` 拦截 Fetch 请求

2. **核心流程**: 实例化时保存配置 → 调用 `observeXHR/observeFetch/observeAll` 代理原生 API → 请求完成时收集信息并触发回调 → `getStats` 遍历记录计算统计 → `stop` 还原原生 API

3. **关键技术点**: Monkey Patching 代理原生 API、`performance.now()` 高精度计时、`Response.clone()` 非破坏性读取响应体、`matchPattern` URL 匹配过滤

4. **数据流向**: 浏览器发起请求 → 代理函数拦截 → 收集请求元数据 → 请求完成后构造 `RequestInfo` → 推入 `requests` 数组 + 触发 `onRequest` 回调 → 失败时触发 `onError` 回调
