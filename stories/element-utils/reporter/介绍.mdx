import initDemo from './initDemo?raw'
import reportDemo from './reportDemo?raw'
import flushDemo from './flushDemo?raw'
import updatePageInfoDemo from './updatePageInfoDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# Reporter

数据上报器，支持 Beacon/Fetch/XHR/Image 多种发送方式，内置批量上报、页面生命周期自动刷新、前后置钩子等能力。

## 详细介绍

Reporter 是一个通用的前端数据上报工具类，基于 `createBatch` 实现批量缓冲与定时上报，使用 `onPageUnload` 和 `visibility` 监听页面卸载/隐藏事件自动 flush 缓存数据，避免数据丢失。

支持 4 种发送方式：Beacon（默认，失败自动降级到 Fetch）、Fetch、XHR、Image，适用于性能监控、错误上报、行为埋点等场景。

## 上报方式对比

<table>
  <thead>
    <tr>
      <th>方式</th>
      <th>协议</th>
      <th>特点</th>
      <th>数据大小限制</th>
      <th>页面卸载可靠性</th>
      <th>适用场景</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Beacon</strong>（默认）</td>
      <td>POST</td>
      <td>浏览器保证异步发送，不阻塞页面卸载，失败自动降级到 Fetch</td>
      <td>64KB（各浏览器不同）</td>
      <td>⭐ 最高</td>
      <td>日常上报首选，尤其适合页面关闭/切换时的数据发送</td>
    </tr>
    <tr>
      <td><strong>Fetch</strong></td>
      <td>POST</td>
      <td>基于 Promise，支持 `keepalive: true` 保障卸载时发送，可获取响应状态</td>
      <td>64KB（keepalive 模式）/ 无限制（普通模式）</td>
      <td>⭐ 高</td>
      <td>需要确认上报结果、需要处理响应、大数据量上报</td>
    </tr>
    <tr>
      <td><strong>XHR</strong></td>
      <td>POST</td>
      <td>兼容性最好（IE9+），同步/异步可选，可获取响应状态</td>
      <td>无限制</td>
      <td>⭐ 低</td>
      <td>需要兼容旧浏览器、需要上传大体量数据</td>
    </tr>
    <tr>
      <td><strong>Image</strong></td>
      <td>GET</td>
      <td>通过 `new Image()` 发起 GET 请求，无跨域问题，无需服务端 CORS 配置</td>
      <td>~2KB（URL 长度限制）</td>
      <td>⭐ 低</td>
      <td>简单埋点打点、跨域受限环境、数据量极小的场景</td>
    </tr>
  </tbody>
</table>

> **推荐策略**：默认使用 Beacon，它在页面卸载时的可靠性最高且不阻塞用户操作。Beacon 发送失败时会自动降级到 Fetch。如果需要兼容旧浏览器可选 XHR，数据量极小且有跨域限制时可选 Image。

## 初始化 Reporter

通过 `new Reporter(options)` 创建实例，配置上报地址、应用 ID、发送方式、批量策略和钩子函数。构造时自动生成 sessionId 和 pageId，并注册页面生命周期事件。

<CodeOrSourceMdx language="typescript">
  {initDemo}
</CodeOrSourceMdx>

## 上报数据

通过 `reporter.report(type, data, immediate?)` 上报不同类型的数据。`immediate` 为 `true` 时跳过批量缓冲直接发送，适合错误等需要即时上报的场景。

<CodeOrSourceMdx language="typescript">
  {reportDemo}
</CodeOrSourceMdx>

## 手动 Flush

调用 `reporter.flush()` 立即将缓存中的所有数据发送出去，适用于用户主动触发或特殊时机需要确保数据已发送的场景。

<CodeOrSourceMdx language="typescript">
  {flushDemo}
</CodeOrSourceMdx>

## 更新页面信息

调用 `reporter.updatePageInfo()` 重新生成 pageId，适用于 SPA 路由变化时标记新页面。

<CodeOrSourceMdx language="typescript">
  {updatePageInfoDemo}
</CodeOrSourceMdx>

## 参数介绍

### ReporterOptions（构造参数）

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>reportUrl</td>
      <td><code>string</code></td>
      <td>上报地址（必填）</td>
    </tr>
    <tr>
      <td>appId</td>
      <td><code>string</code></td>
      <td>应用 ID</td>
    </tr>
    <tr>
      <td>reportMethod</td>
      <td><code>REPORT_METHOD</code></td>
      <td>上报方式，默认 BEACON</td>
    </tr>
    <tr>
      <td>batchSize</td>
      <td><code>number</code></td>
      <td>批量上报阈值，默认 10</td>
    </tr>
    <tr>
      <td>reportInterval</td>
      <td><code>number</code></td>
      <td>上报间隔（ms），默认 5000</td>
    </tr>
    <tr>
      <td>beforeReport</td>
      <td><code>(data: ReportData) =&gt; ReportData | false</code></td>
      <td>上报前处理钩子，返回 false 取消上报</td>
    </tr>
    <tr>
      <td>afterReport</td>
      <td><code>(data: ReportData, success: boolean) =&gt; void</code></td>
      <td>上报后处理钩子</td>
    </tr>
  </tbody>
</table>

### report 方法参数

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>type</td>
      <td><code>REPORT_TYPE</code></td>
      <td>数据类型（performance / error / request / behavior / custom）</td>
    </tr>
    <tr>
      <td>data</td>
      <td><code>unknown</code></td>
      <td>具体数据</td>
    </tr>
    <tr>
      <td>immediate</td>
      <td><code>boolean</code></td>
      <td>是否立即上报，默认 false</td>
    </tr>
  </tbody>
</table>

### 返回值（Reporter 实例方法）

<table>
  <thead>
    <tr>
      <th>方法名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>report</td>
      <td><code>(type, data, immediate?) =&gt; void</code></td>
      <td>上报数据</td>
    </tr>
    <tr>
      <td>flush</td>
      <td><code>() =&gt; void</code></td>
      <td>刷新缓存，立即上报</td>
    </tr>
    <tr>
      <td>updatePageInfo</td>
      <td><code>() =&gt; void</code></td>
      <td>更新页面 ID（SPA 路由变化）</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

1. **index.ts**：Reporter class 主入口，负责实例化配置、批量管理（委托 `createBatch`）、数据构建、发送路由和生命周期绑定
2. **interface.ts**：类型定义，包含 `REPORT_METHOD`/`REPORT_TYPE` 枚举、`ReportData`/`ReporterOptions` 接口
3. **core/sendByBeacon.ts**：Beacon API 发送，失败自动降级到 Fetch
4. **core/sendByFetch.ts**：Fetch API 发送，使用 `keepalive: true` 确保页面卸载时数据可达
5. **core/sendByXHR.ts**：XMLHttpRequest 发送，兼容旧浏览器
6. **core/sendByImage.ts**：Image 像素上报，适合简单的 GET 请求场景

核心流程：`report()` 构建 `ReportData` → 根据 `immediate` 决定立即发送或加入 `createBatch` 缓冲 → `send()` 中执行 `beforeReport` 过滤 → 根据 `reportMethod` 选择发送方式 → 执行 `afterReport` 回调。页面卸载/隐藏时通过 `onPageUnload` 和 `visibility` 自动触发 `flush`。
