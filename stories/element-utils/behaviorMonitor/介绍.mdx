import initDemo from './initDemo?raw'
import selectiveDemo from './selectiveDemo?raw'
import trackCustomDemo from './trackCustomDemo?raw'
import breadcrumbDemo from './breadcrumbDemo?raw'
import stopDemo from './stopDemo?raw'
import observeClickDemo from './observeClickDemo?raw'
import observeScrollDemo from './observeScrollDemo?raw'
import observeInputDemo from './observeInputDemo?raw'
import observeRouteChangeDemo from './observeRouteChangeDemo?raw'
import observeVisibilityDemo from './observeVisibilityDemo?raw'
import { CodeOrSourceMdx } from '@storybook/addon-docs/blocks'

# behaviorMonitor

用户行为监控器，统一追踪页面中的点击、滚动、输入、路由变化和页面可见性等行为事件。

## 详细介绍

`BehaviorMonitor` 是一个基于类的用户行为监控工具，将五种常见的用户行为捕获方式封装为统一的回调接口，并内置行为面包屑追踪能力。

底层分别通过以下机制监控不同类型的行为：

- **点击行为**：`document.addEventListener('click')` — 在捕获阶段监听点击事件，记录坐标和目标元素信息
- **滚动行为**：`window.addEventListener('scroll')` — 监听页面滚动，内置节流处理
- **输入行为**：`document.addEventListener('input')` — 监听表单输入，支持敏感字段过滤和值脱敏
- **路由变化**：劫持 `history.pushState`/`replaceState` + 监听 `popstate`/`hashchange` — 同时支持 History 和 Hash 路由
- **页面可见性**：`document.addEventListener('visibilitychange')` — 监听页面前后台切换

常见使用场景：用户行为分析、操作面包屑追踪、错误排查时的操作路径回溯、用户体验优化数据收集。

## 基础监听

实例化 `BehaviorMonitor` 后调用 `observe` 方法即可启动所有行为监控。回调函数接收 `BehaviorInfo` 对象，包含行为类型、时间戳、页面 URL 和额外数据。返回的清理函数用于停止所有监听。

<CodeOrSourceMdx language="typescript">
  {initDemo}
</CodeOrSourceMdx>

## 选择性监控

通过构造函数配置项可以按需开启或关闭特定类型的行为监控，同时可以对每种监控传入细化配置（如采样率、节流间隔、是否记录输入值等）。

<CodeOrSourceMdx language="typescript">
  {selectiveDemo}
</CodeOrSourceMdx>

## 点击行为监控

`observeClick` 通过 `createEventListener` 在 document 上监听 click 事件。默认在捕获阶段（`capture: true`）监听，确保能捕获到所有点击，即使子元素阻止了冒泡。回调中包含点击坐标（`clientX`/`clientY`）、鼠标按键（`button`）以及通过 `getElementInfo` 获取的目标元素信息（标签名、ID、类名、XPath 等）。`sampleRate` 控制采样率，值为 0-1 之间，小于 1 时随机丢弃部分事件。

<CodeOrSourceMdx language="typescript">
  {observeClickDemo}
</CodeOrSourceMdx>

## 滚动行为监控

`observeScroll` 通过 `createEventListener` 在 window 上监听 scroll 事件，使用 `passive: true` 避免阻塞滚动性能。内置 `throttle` 节流（默认 200ms），避免高频触发。回调数据包含 `scrollTop`/`scrollLeft` 滚动位置、`scrollHeight`/`scrollWidth` 文档总尺寸以及 `viewportHeight`/`viewportWidth` 视口尺寸，可用于计算滚动百分比和阅读深度。

<CodeOrSourceMdx language="typescript">
  {observeScrollDemo}
</CodeOrSourceMdx>

## 输入行为监控

`observeInput` 通过 `createEventListener` 在 document 上监听 input 事件。使用 `WeakMap` 为每个输入元素维护独立的节流定时器，避免内存泄漏。支持敏感字段检测：当 `type` 为 `password` 或元素的 `name`/`id` 包含 `sensitiveFields` 中的关键词时，不记录输入值。`recordValue` 默认关闭，开启后使用 `truncate` 截断过长文本。

<CodeOrSourceMdx language="typescript">
  {observeInputDemo}
</CodeOrSourceMdx>

## 路由变化监控

`observeRouteChange` 同时支持 History API 和 Hash 路由两种模式。通过劫持 `history.pushState` 和 `history.replaceState` 拦截编程式导航，同时监听 `popstate`（浏览器前进/后退）和 `hashchange`（Hash 变化）事件。回调数据包含 `from`（来源 URL）、`to`（目标 URL）和 `trigger`（触发方式：pushState/replaceState/popstate/hashchange）。清理时恢复原始 History API 方法。

<CodeOrSourceMdx language="typescript">
  {observeRouteChangeDemo}
</CodeOrSourceMdx>

## 页面可见性监控

`observeVisibility` 通过 `createEventListener` 在 document 上监听 `visibilitychange` 事件，捕获页面前后台切换。回调数据包含 `visible`（是否可见）和 `visibilityState`（`visible`/`hidden`）。常用于统计用户停留时长、暂停/恢复定时任务等场景。

<CodeOrSourceMdx language="typescript">
  {observeVisibilityDemo}
</CodeOrSourceMdx>

## 自定义行为追踪

`trackCustom` 方法允许记录业务自定义行为，无需调用 `observe` 也可独立使用。自定义行为同样会被加入面包屑记录中，可通过 `getBehaviors` 获取。

<CodeOrSourceMdx language="typescript">
  {trackCustomDemo}
</CodeOrSourceMdx>

## 面包屑追踪

通过 `maxBehaviors` 限制最大行为记录数，超出后自动丢弃最旧的记录，实现滚动窗口式的面包屑追踪。`getBehaviors` 返回当前记录副本，`clear` 清空所有记录。

<CodeOrSourceMdx language="typescript">
  {breadcrumbDemo}
</CodeOrSourceMdx>

## 启停控制

`observe` 返回停止函数，调用后清理所有事件监听器并恢复被劫持的 History API。`isRunning` 可查询当前运行状态，重复调用 `observe` 不会创建重复监听。

<CodeOrSourceMdx language="typescript">
  {stopDemo}
</CodeOrSourceMdx>

## 参数介绍

### 构造函数 `new BehaviorMonitor(options?)`

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>options.click</td>
      <td><code>boolean</code></td>
      <td>是否监控点击行为，默认 <code>true</code></td>
    </tr>
    <tr>
      <td>options.scroll</td>
      <td><code>boolean</code></td>
      <td>是否监控滚动行为，默认 <code>true</code></td>
    </tr>
    <tr>
      <td>options.input</td>
      <td><code>boolean</code></td>
      <td>是否监控输入行为，默认 <code>true</code></td>
    </tr>
    <tr>
      <td>options.routeChange</td>
      <td><code>boolean</code></td>
      <td>是否监控路由变化，默认 <code>true</code></td>
    </tr>
    <tr>
      <td>options.maxBehaviors</td>
      <td><code>number</code></td>
      <td>最大行为记录数，默认 <code>100</code></td>
    </tr>
    <tr>
      <td>options.clickOptions</td>
      <td><code>ObserveClickOptions</code></td>
      <td>点击监控配置（capture、sampleRate）</td>
    </tr>
    <tr>
      <td>options.scrollOptions</td>
      <td><code>ObserveScrollOptions</code></td>
      <td>滚动监控配置（throttleMs、sampleRate）</td>
    </tr>
    <tr>
      <td>options.inputOptions</td>
      <td><code>ObserveInputOptions</code></td>
      <td>输入监控配置（recordValue、sensitiveFields、throttleMs）</td>
    </tr>
  </tbody>
</table>

### ObserveClickOptions

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>capture</td>
      <td><code>boolean</code></td>
      <td>是否在捕获阶段监听，默认 <code>true</code></td>
    </tr>
    <tr>
      <td>sampleRate</td>
      <td><code>number</code></td>
      <td>采样率（0-1），默认 <code>1</code></td>
    </tr>
  </tbody>
</table>

### ObserveScrollOptions

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>throttleMs</td>
      <td><code>number</code></td>
      <td>节流间隔（ms），默认 <code>200</code></td>
    </tr>
    <tr>
      <td>sampleRate</td>
      <td><code>number</code></td>
      <td>采样率（0-1），默认 <code>1</code></td>
    </tr>
  </tbody>
</table>

### ObserveInputOptions

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>recordValue</td>
      <td><code>boolean</code></td>
      <td>是否记录输入值，默认 <code>false</code></td>
    </tr>
    <tr>
      <td>sensitiveFields</td>
      <td><code>string[]</code></td>
      <td>敏感字段列表，匹配的字段不记录值</td>
    </tr>
    <tr>
      <td>throttleMs</td>
      <td><code>number</code></td>
      <td>节流间隔（ms），默认 <code>500</code></td>
    </tr>
  </tbody>
</table>

### 实例方法

<table>
  <thead>
    <tr>
      <th>方法</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>observe</td>
      <td><code>(callback: BehaviorCallback) =&gt; StopListening</code></td>
      <td>启动行为监控，返回停止函数</td>
    </tr>
    <tr>
      <td>stop</td>
      <td><code>() =&gt; void</code></td>
      <td>停止所有行为监控</td>
    </tr>
    <tr>
      <td>getBehaviors</td>
      <td><code>() =&gt; BehaviorInfo[]</code></td>
      <td>获取行为记录副本</td>
    </tr>
    <tr>
      <td>clear</td>
      <td><code>() =&gt; void</code></td>
      <td>清空行为记录</td>
    </tr>
    <tr>
      <td>trackCustom</td>
      <td><code>(name: string, data?: Record&lt;string, unknown&gt;) =&gt; BehaviorInfo</code></td>
      <td>记录自定义行为</td>
    </tr>
    <tr>
      <td>isRunning</td>
      <td><code>() =&gt; boolean</code></td>
      <td>查询是否正在运行</td>
    </tr>
  </tbody>
</table>

### BehaviorInfo

<table>
  <thead>
    <tr>
      <th>字段</th>
      <th>类型</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>type</td>
      <td><code>'click' | 'scroll' | 'input' | 'navigate' | 'custom'</code></td>
      <td>行为类型</td>
    </tr>
    <tr>
      <td>timestamp</td>
      <td><code>number</code></td>
      <td>发生时间戳</td>
    </tr>
    <tr>
      <td>pageUrl</td>
      <td><code>string</code></td>
      <td>页面 URL</td>
    </tr>
    <tr>
      <td>target</td>
      <td><code>ElementInfo</code></td>
      <td>目标元素信息（可选）</td>
    </tr>
    <tr>
      <td>data</td>
      <td><code>Record&lt;string, unknown&gt;</code></td>
      <td>额外数据（可选）</td>
    </tr>
  </tbody>
</table>

## 具体实现原理

1. **文件职责**：
   - `index.ts`：`BehaviorMonitor` 类，管理监控生命周期、行为记录和自定义行为追踪
   - `interface.ts`：类型定义，包含 `BehaviorInfo`、`BehaviorMonitorOptions`、各监控配置项、`BEHAVIOR_TYPE`/`ROUTE_TRIGGER` 枚举及常量（`PASSWORD_INPUT_TYPE`、`DEFAULT_SENSITIVE_FIELDS`、`DEFAULT_MAX_BEHAVIORS`）
   - `core/observeClick.ts`：通过 `createEventListener` 监听 document 的 click 事件，使用 `getElementInfo` 获取目标元素信息，支持 capture 和 sampleRate 配置
   - `core/observeScroll.ts`：通过 `createEventListener` 监听 window 的 scroll 事件，使用 `throttle` 节流，记录完整的滚动位置和视口信息
   - `core/observeInput.ts`：通过 `createEventListener` 监听 document 的 input 事件，使用 `WeakMap` 实现按元素独立的节流定时器，支持 `PASSWORD_INPUT_TYPE` 和 `sensitiveFields` 敏感字段过滤
   - `core/observeRouteChange.ts`：劫持 `history.pushState`/`replaceState` 并通过 `createEventListener` 监听 `popstate`/`hashchange`，通过 `lastUrl` 去重避免重复触发
   - `core/observeVisibility.ts`：通过 `createEventListener` 监听 document 的 visibilitychange 事件，记录 `visibilityState` 状态

2. **核心流程**：
   - 构造函数接收配置项，`observe` 方法根据 `click`/`scroll`/`input`/`routeChange` 开关按需启动各子监控，`observeVisibility` 始终启用
   - 用 `wrappedCallback` 包装回调，在触发外部回调前先通过 `addBehavior` 写入面包屑记录
   - 各子监控函数通过 `createEventListener` 注册事件，返回 `StopListening` 清理函数，统一收集到 `stoppers` 数组
   - `stop` 方法遍历调用所有 stopper 并重置 `running` 状态，`observe` 内部的 `isRunning` 检查防止重复监听

3. **关键技术点**：
   - 行为记录采用滚动窗口，通过 `maxBehaviors`（默认 100）限制数组长度，超出后 `slice(-maxBehaviors)` 截取最近记录
   - `getBehaviors` 返回数组浅拷贝（`[...this.behaviors]`），防止外部修改内部状态
   - 路由监控通过劫持 History API 实现 SPA 路由变化检测，使用 `lastUrl` 缓存上次 URL 避免相同 URL 重复上报，清理时恢复原始方法引用
   - 输入监控使用 `WeakMap<Element, Timer>` 为每个输入元素维护独立的节流定时器，元素被 GC 后定时器自动清理
   - 滚动监控使用 `passive: true` 选项确保不阻塞浏览器滚动渲染
   - 所有事件监听统一使用内部的 `createEventListener` 工具封装，简化注册/清理流程
