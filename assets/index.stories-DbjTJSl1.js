import{j as a}from"./jsx-runtime-u17CrQMm.js";/* empty css              */import{d as k}from"./index-DCVOHr8a.js";import{B as y}from"./index-BeKXAz7q.js";import{E as w}from"./index-CwqKHT5z.js";import{F as D}from"./index-DaUpxYCs.js";import{g as P}from"./index-CD34cSy0.js";import{g as A}from"./index-nL6JsiBQ.js";import{g as F}from"./index-amFXFPEa.js";import{J as N}from"./index-CozjGhNV.js";import{L as $}from"./index-Ch4uGxnA.js";import{o as U}from"./index-Due9vDYA.js";import{P as B}from"./index-Cyoyvr5N.js";import{b as f,R as V,P as d}from"./index-BhBzrgsn.js";import{R as L}from"./index-CUfryva0.js";import{R as E}from"./index-CYEuc-hq.js";import{s as b}from"./index-CCP8emSp.js";import{W as x}from"./index-unHVUpRi.js";import"./index-HlNQgXsc.js";import"./index-GMzEpHqB.js";import"./index-CPTfiPhJ.js";import"./index-BtXwjIh0.js";import"./index-DbXIB-0m.js";import"./index-DhV1O_Ae.js";import"./index-xKxNytmu.js";import"./index-Be32pr3j.js";import"./index-CSDXyHsi.js";import"./index-QD0SLaeG.js";import"./index-EnvM_XjC.js";import"./index-DOJC9J_n.js";import"./index-DL3VI9dp.js";import"./index-B1yd03Fi.js";import"./interface-l7xTqOLs.js";import"./index-DIcNE1hc.js";import"./performanceObserver-wogupI_g.js";import"./interface-Xy6dxNqB.js";import"./index-BvINh1mj.js";import"./index-vw0CbWNS.js";import"./index-Dy4Jlylv.js";import"./index-Hh3QjLfa.js";import"./index-DTeKS9Q9.js";import"./index-DDoPo_J-.js";import"./index-C6lvCn9q.js";import"./index-D75VQskf.js";import"./index-B_-fQMag.js";import"./index-DPNnPLch.js";import"./index-Cr6y8Y03.js";import"./index-DRbt2l9s.js";import"./index-Bfe0ZkV7.js";import"./index-BecUxZRD.js";import"./index-BINnBmJz.js";import"./index-D2Y4DYgy.js";import"./index-CiAGgNxw.js";import"./index-CRyfxVlp.js";import"./index-Bwv5fkBO.js";import"./index-DADV4aVQ.js";import"./index-oytXLUsV.js";import"./index-BBae2uCj.js";import"./index-O4ucCvDK.js";import"./index-nTjGkKWs.js";import"./index-B3RPGl_z.js";import"./index-yvfzGEcD.js";import"./index-B_uU3mD0.js";import"./index-CeTF1X9l.js";import"./index-DG75V_b_.js";const z={enabled:!0,sampleRate:1,reportMethod:"beacon",batchSize:10,reportInterval:5e3,maxCacheSize:100,performance:{enabled:!0,webVitals:!0,resource:!0,longTask:!0,longTaskThreshold:50,fps:!1,jank:!1,jankThreshold:100,navigation:!0},error:{enabled:!0,jsError:!0,resourceError:!0,promiseError:!0,requestError:!0,ignoreErrors:[]},request:{enabled:!0,xhr:!0,fetch:!0,ignoreUrls:[],timeoutThreshold:3e4},behavior:{enabled:!1,click:!0,scroll:!0,input:!0,routeChange:!0,maxBehaviors:100},lifecycle:{enabled:!1}};class I{config;reporter;running=!1;stoppers=[];longTaskMonitor;resourceMonitor;behaviorMonitor;requestMonitor;errorMonitor;pageLifecycleMonitor;jankMonitor;webVitalsMonitor;fpsMonitor;constructor(e){this.config=k({...z},e??{}),this.reporter=this.createReporter(),this.errorMonitor=new w({jsError:this.config.error?.jsError,resourceError:this.config.error?.resourceError,promiseError:this.config.error?.promiseError,errorFilter:this.config.error?.errorFilter}),this.pageLifecycleMonitor=new B,this.jankMonitor=new N({threshold:this.config.performance?.jankThreshold}),this.webVitalsMonitor=new x({reportAllChanges:!1}),this.fpsMonitor=new D,this.longTaskMonitor=new $,this.resourceMonitor=new E({filter:this.config.performance?.resourceFilter}),this.behaviorMonitor=new y({click:this.config.behavior?.click,scroll:this.config.behavior?.scroll,input:this.config.behavior?.input,routeChange:this.config.behavior?.routeChange,maxBehaviors:this.config.behavior?.maxBehaviors}),this.requestMonitor=new L({onRequest:t=>{this.reporter.report(f.REQUEST,t)},onError:this.config.error?.requestError?this.requestErrorCallback:void 0,ignoreUrls:this.config.request?.ignoreUrls,timeoutThreshold:this.config.request?.timeoutThreshold})}start=()=>{if(this.running||!this.config.enabled||!this.shouldSample())return;this.running=!0;const{performance:e,error:t,request:s,behavior:c,lifecycle:r}=this.config;e?.enabled&&(e.webVitals&&this.startWebVitalsMonitor(),e.resource&&this.startResourceMonitor(),e.longTask&&this.startLongTaskMonitor(),e.fps&&this.startFpsMonitor(),e.jank&&this.startJankMonitor(),e.navigation!==!1&&this.startNavigationReport()),t?.enabled&&this.startErrorMonitor(),s?.enabled&&(s.xhr&&this.startXHRMonitor(),s.fetch&&this.startFetchMonitor()),c?.enabled&&this.startBehaviorMonitor(),r?.enabled&&this.startLifecycleMonitor()};stop=()=>{this.running&&(this.running=!1,this.stoppers.forEach(e=>e()),this.stoppers.length=0,this.requestMonitor.stop())};updateConfig=e=>{this.config=k(this.config,e),this.reporter=this.createReporter()};getNavigationMetrics=()=>P();getPageInfo=()=>A();getPaintMetrics=()=>F();createReporter=()=>new V({reportUrl:this.config.reportUrl??"",reportMethod:this.config.reportMethod,batchSize:this.config.batchSize,reportInterval:this.config.reportInterval,appId:this.config.appId,beforeReport:this.config.hooks?.beforeReport,afterReport:this.config.hooks?.afterReport});errorCallback=e=>{this.reporter.report(f.ERROR,e),this.config.hooks?.onError?.(e)};requestErrorCallback=e=>{this.reporter.report(f.ERROR,e)};shouldSample=()=>b(this.config.sampleRate);startWebVitalsMonitor=()=>{const e=this.webVitalsMonitor.observe(t=>{this.reportPerformance(d.WEB_VITALS,t),this.config.hooks?.onMetric?.(t)});this.stoppers.push(e)};startResourceMonitor=()=>{const e=this.resourceMonitor.observe(t=>{this.reportPerformance(d.RESOURCE,t)});this.stoppers.push(e)};startLongTaskMonitor=()=>{const e=this.longTaskMonitor.observe(t=>this.reportPerformance(d.LONG_TASK,t),{threshold:this.config.performance.longTaskThreshold});this.stoppers.push(e)};startFpsMonitor=()=>{const e=this.fpsMonitor.observe(t=>{this.reportPerformance(d.FPS,t)});this.stoppers.push(e)};startJankMonitor=()=>{const e=this.jankMonitor.observe(t=>this.reportPerformance(d.JANK,t));this.stoppers.push(e)};startNavigationReport=()=>{const e=U(()=>{const t=P();this.reportPerformance(d.NAVIGATION,t)});this.stoppers.push(e)};startErrorMonitor=()=>{const e=this.errorMonitor.observe(this.errorCallback);this.stoppers.push(e)};startXHRMonitor=()=>{this.requestMonitor.observeXHR()};startFetchMonitor=()=>{this.requestMonitor.observeFetch()};startBehaviorMonitor=()=>{const e=this.behaviorMonitor.observe(t=>{this.reporter.report(f.BEHAVIOR,[t])});this.stoppers.push(e)};startLifecycleMonitor=()=>{const e=this.pageLifecycleMonitor.observe();this.stoppers.push(e)};reportPerformance=(e,t)=>{this.reporter.report(f.PERFORMANCE,{metricType:e,metrics:t})}}const{action:l}=__STORYBOOK_MODULE_ACTIONS__,K=()=>{const o=new I({appId:"storybook-demo",sampleRate:1,performance:{webVitals:!0,resource:!0,longTask:!0,longTaskThreshold:50},error:{jsError:!0,resourceError:!0,promiseError:!0,ignoreErrors:[/Script error/]},request:{xhr:!0,fetch:!0,ignoreUrls:[/analytics/,/report/]},behavior:{enabled:!0,click:!0,scroll:!0,input:!0,routeChange:!0},hooks:{onMetric:r=>{l("Web Vitals 指标")({name:r.name,value:r.value,rating:r.rating})},onError:r=>{l("捕获错误")({type:r.type,message:r.message})}}});o.start(),l("监控状态")("已启动");const e=o.getNavigationMetrics(),t=o.resourceMonitor.getMetrics(),s=o.longTaskMonitor.getStats(),c=o.getPageInfo();l("导航性能指标")(e),l("资源性能指标")(t.slice(0,5)),l("长任务统计")(s),l("页面信息")(c),o.reporter.report("custom",{event:"button_click",buttonId:"demo-button",timestamp:Date.now()}),l("自定义事件")("已上报 button_click 事件"),setTimeout(()=>{o.stop(),l("监控状态")("已停止")},5e3)},{action:R}=__STORYBOOK_MODULE_ACTIONS__,q=()=>{const e=new x({reportAllChanges:!0}).observe(t=>{R(`Web Vitals - ${t.name}`)({value:t.value,rating:t.rating,delta:t.delta})});R("Web Vitals 监控")("已启动统一监控，包含 LCP、FID、CLS、FCP、FP、INP、TTFB"),setTimeout(()=>{e(),R("Web Vitals 监控")("已停止所有监控")},5e3)},{action:T}=__STORYBOOK_MODULE_ACTIONS__,Y=()=>{const e=new w({jsError:!0,resourceError:!0,promiseError:!0,consoleError:!1,errorFilter:t=>!(/Script error/.test(t.message)||/ResizeObserver loop/.test(t.message))}).observe(t=>{T(`错误 - ${t.type}`)({message:t.message,stack:t.stack?.slice(0,200),timestamp:new Date(t.timestamp).toLocaleString()})});T("错误监控")("已启动所有错误监控（JS / Resource / Promise）"),setTimeout(()=>{T("触发测试")("即将触发 Promise 错误"),Promise.reject(new Error("测试 Promise 错误"))},1e3),setTimeout(()=>{e(),T("错误监控")("已停止所有错误监控")},5e3)},{action:p}=__STORYBOOK_MODULE_ACTIONS__,W=()=>{const o=new L({onRequest:r=>{p("网络请求")({method:r.method,url:r.url.slice(0,100),duration:`${r.duration}ms`,status:r.status,success:r.success})},onError:r=>{p("请求错误")({url:r.requestUrl,message:r.message})},ignoreUrls:[/analytics/,/report/,/localhost/],timeoutThreshold:3e4});o.observeXHR(),o.observeFetch(),p("请求监控")("已启动所有请求监控");const e=new E,t=e.observe(r=>{r.forEach(i=>{p("资源加载")({name:i.name.split("/").pop(),type:i.initiatorType,duration:`${Math.round(i.duration)}ms`,size:i.transferSize>0?`${(i.transferSize/1024).toFixed(1)}KB`:"cached",fromCache:i.fromCache})})});p("资源监控")("已启动资源加载监控");const s=e.getMetrics();p("已加载资源")(s.slice(0,5).map(r=>({name:r.name.split("/").pop(),type:r.initiatorType,duration:`${Math.round(r.duration)}ms`})));const c=e.getStats();p("资源统计")(c),setTimeout(()=>{p("测试请求")("发起 fetch 请求"),fetch("https://jsonplaceholder.typicode.com/todos/1").then(r=>r.json()).then(r=>{p("请求响应")(r)}).catch(r=>{p("请求失败")(r.message)})},500),setTimeout(()=>{const r=o.getStats();p("请求统计汇总")({total:r.total,success:r.success,failed:r.failed,avgDuration:`${Math.round(r.avgDuration)}ms`})},3e3),setTimeout(()=>{o.stop(),t(),p("请求监控")("已停止所有监控")},5e3)},{action:m}=__STORYBOOK_MODULE_ACTIONS__,H=()=>{const o=new E({filter:i=>!i.name.includes("hot-update")});m("资源监控")("已启动");const e=o.observe(i=>{i.forEach(h=>{m(`新资源 - ${h.initiatorType}`)({name:h.name.split("/").pop(),duration:`${Math.round(h.duration)}ms`,size:h.transferSize>0?`${(h.transferSize/1024).toFixed(1)}KB`:"cached",fromCache:h.fromCache})})}),t=o.getMetrics();m("已加载资源总数")(t.length),m("已加载资源（前5个）")(t.slice(0,5).map(i=>({name:i.name.split("/").pop(),type:i.initiatorType,duration:`${Math.round(i.duration)}ms`})));const s=o.getStats();m("资源统计")({total:s.total,cached:s.cached,totalSize:`${(s.totalSize/1024).toFixed(1)}KB`,totalDuration:`${Math.round(s.totalDuration)}ms`,byType:s.byType});const c=o.getSlowResources(500);m("慢资源（>500ms）")(c.length>0?c.map(i=>({name:i.name.split("/").pop(),duration:`${Math.round(i.duration)}ms`})):"无慢资源");const r=o.getLargeResources(100*1024);m("大资源（>100KB）")(r.length>0?r.map(i=>({name:i.name.split("/").pop(),size:`${(i.transferSize/1024).toFixed(1)}KB`})):"无大资源"),setTimeout(()=>{e(),m("资源监控")("已停止")},5e3)},{action:v}=__STORYBOOK_MODULE_ACTIONS__,J=()=>{const o=F();if(!o){v("绘制指标")("当前环境不支持 Paint Timing API 或数据尚未就绪");return}v("FP (First Paint)")({value:`${Math.round(o.FP)}ms`,rating:o.FPRating,description:"浏览器首次在屏幕上渲染像素的时间"}),v("FCP (First Contentful Paint)")({value:`${Math.round(o.FCP)}ms`,rating:o.FCPRating,description:"首次渲染文本、图片、SVG 等内容的时间"}),v("绘制指标说明")("FP 和 FCP 基于 Paint Timing API，从 navigation fetchStart 开始计算")},{action:g}=__STORYBOOK_MODULE_ACTIONS__,G=()=>{const o=new y({click:!0,scroll:!0,input:!0,routeChange:!0,maxBehaviors:50}),e=o.observe(s=>{g(`行为 - ${s.type}`)({pageUrl:s.pageUrl.slice(0,80),target:s.target?`<${s.target.tagName}> ${s.target.innerText?.slice(0,30)||""}`:void 0,data:s.data,timestamp:new Date(s.timestamp).toLocaleTimeString()})});g("行为监控")("已启动（点击/滚动/输入/路由/可见性），请在页面上进行操作");const t=o.trackCustom("demo_started",{source:"storybook",version:"1.0"});g("自定义行为")(t),setTimeout(()=>{const s=o.getBehaviors();g("行为记录汇总")({total:s.length,types:s.map(c=>c.type)})},3e3),setTimeout(()=>{e(),g("行为监控")("已停止")},5e3)},{action:C}=__STORYBOOK_MODULE_ACTIONS__,X=()=>{const e=new D().observe(t=>{const s=t>=55?"good":t>=30?"needs-improvement":"poor";C(`FPS - ${s}`)({fps:t,description:t>=55?"流畅":t>=30?"轻微卡顿":"严重卡顿"})});C("FPS 监控")("已启动，每秒上报一次帧率"),setTimeout(()=>{e(),C("FPS 监控")("已停止")},5e3)},{action:M}=__STORYBOOK_MODULE_ACTIONS__,Q=()=>{const e=new N({threshold:100}).observe(t=>{M("卡顿检测")({duration:`${Math.round(t.duration)}ms`,timestamp:new Date(t.timestamp).toLocaleTimeString(),description:"帧间隔超过 100ms，发生卡顿"})});M("卡顿监控")("已启动（阈值 100ms），尝试执行重计算触发卡顿"),setTimeout(()=>{M("模拟卡顿")("开始执行 200ms 的同步计算...");const t=performance.now();for(;performance.now()-t<200;);M("模拟卡顿")("计算完成")},1e3),setTimeout(()=>{e(),M("卡顿监控")("已停止")},5e3)},{action:u}=__STORYBOOK_MODULE_ACTIONS__,Z=()=>{const o=new $,e=o.observe(t=>{u("长任务检测")({name:t.name,duration:`${Math.round(t.duration)}ms`,startTime:`${Math.round(t.startTime)}ms`,attribution:t.attribution})},{threshold:50,reportExisting:!0});u("长任务监控")("已启动（阈值 50ms）"),setTimeout(()=>{u("模拟长任务")("开始执行 150ms 的同步计算...");const t=performance.now();for(;performance.now()-t<150;);u("模拟长任务")("计算完成")},500),setTimeout(()=>{const t=o.getStats();u("长任务统计")({count:t.count,totalDuration:`${Math.round(t.totalDuration)}ms`,maxDuration:`${Math.round(t.maxDuration)}ms`,avgDuration:`${Math.round(t.avgDuration)}ms`});const s=o.calculateTBT();u("TBT (Total Blocking Time)")(`${Math.round(s)}ms`)},3e3),setTimeout(()=>{e(),u("长任务监控")("已停止")},5e3)},{action:n}=__STORYBOOK_MODULE_ACTIONS__,tt=()=>{const o=new B({DOMContentLoaded:t=>{n("生命周期 - DOMContentLoaded")({type:t?.type,description:"DOM 解析完成"})},load:t=>{n("生命周期 - Load")({type:t?.type,description:"页面完全加载"})},pageshow:t=>{n("生命周期 - PageShow")({persisted:t?.persisted,description:t?.persisted?"BFCache 恢复":"正常展示"})},pagehide:t=>{n("生命周期 - PageHide")({persisted:t?.persisted,description:"页面隐藏"})},visibilitychange:()=>{n("生命周期 - VisibilityChange")({state:document.visibilityState,description:document.visibilityState==="hidden"?"页面不可见":"页面可见"})},focus:()=>{n("生命周期 - Focus")("窗口获得焦点")},blur:()=>{n("生命周期 - Blur")("窗口失去焦点")},online:()=>{n("生命周期 - Online")("网络恢复")},offline:()=>{n("生命周期 - Offline")("网络断开")},popstate:()=>{n("生命周期 - Popstate")("浏览器前进/后退")},hashchange:()=>{n("生命周期 - Hashchange")("URL hash 变化")},freeze:()=>{n("生命周期 - Freeze")("页面被冻结（Page Lifecycle API）")},resume:()=>{n("生命周期 - Resume")("页面从冻结中恢复")}});n("生命周期监控")("已启动，请切换标签页、聚焦/失焦窗口等操作查看事件");const e=o.observe();setTimeout(()=>{e(),n("生命周期监控")("已停止")},1e4)},{action:_}=__STORYBOOK_MODULE_ACTIONS__,et=()=>{const o=new I({appId:"storybook-demo",performance:{webVitals:!1,resource:!1,longTask:!1,fps:!1,jank:!1,navigation:!1},error:{enabled:!1},request:{enabled:!1},behavior:{enabled:!1},lifecycle:{enabled:!1}});_("初始配置")({performance:o.config.performance,error:o.config.error?.enabled,request:o.config.request?.enabled}),o.updateConfig({performance:{webVitals:!0,fps:!0}}),_("更新后配置")({webVitals:o.config.performance?.webVitals,fps:o.config.performance?.fps,resource:o.config.performance?.resource}),o.updateConfig({sampleRate:.5,reportMethod:"fetch",batchSize:20}),_("再次更新配置")({sampleRate:o.config.sampleRate,reportMethod:o.config.reportMethod,batchSize:o.config.batchSize}),_("updateConfig 说明")("updateConfig 使用 deepMerge 进行深度合并，只更新传入的字段，不影响其他配置")},{action:O}=__STORYBOOK_MODULE_ACTIONS__,ot=()=>{const o=Array.from({length:10},()=>b(1));O("采样率 1（全量）")(o.every(Boolean)?"全部命中":o);const e=Array.from({length:10},()=>b(0));O("采样率 0（不采集）")(e.every(c=>!c)?"全部未命中":e);const t=100,s=Array.from({length:t},()=>b(.5)).filter(Boolean).length;O("采样率 0.5（50%）")({total:t,hits:s,hitRate:`${s}%`,description:"基于 Math.random() < sampleRate 判断"}),O("默认值（不传参）")(b()?"命中（默认 sampleRate=1）":"未命中")},j=()=>a.jsxs("div",{children:[a.jsx("div",{className:"button",onClick:K,children:"基础用法"}),a.jsx("div",{className:"button",onClick:q,children:"Web Vitals 监控"}),a.jsx("div",{className:"button",onClick:J,children:"绘制指标 (FP/FCP)"}),a.jsx("div",{className:"button",onClick:Y,children:"错误监控"}),a.jsx("div",{className:"button",onClick:W,children:"请求监控"}),a.jsx("div",{className:"button",onClick:H,children:"资源监控"}),a.jsx("div",{className:"button",onClick:G,children:"行为监控"}),a.jsx("div",{className:"button",onClick:X,children:"FPS 监控"}),a.jsx("div",{className:"button",onClick:Q,children:"卡顿监控"}),a.jsx("div",{className:"button",onClick:Z,children:"长任务监控"}),a.jsx("div",{className:"button",onClick:tt,children:"生命周期监控"}),a.jsx("div",{className:"button",onClick:et,children:"动态更新配置"}),a.jsx("div",{className:"button",onClick:ot,children:"采样率判断"})]});j.__docgenInfo={description:"",methods:[],displayName:"SurveillanceDemo"};const de={title:"element-utils/surveillance",component:j,parameters:{layout:"centered"},argTypes:{}},S={};S.parameters={...S.parameters,docs:{...S.parameters?.docs,source:{originalSource:"{}",...S.parameters?.docs?.source}}};const fe=["Demo"];export{S as Demo,fe as __namedExportsOrder,de as default};
