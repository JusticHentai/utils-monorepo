import{i as y}from"./index-HlNQgXsc.js";import{i as H}from"./index-DL3VI9dp.js";import{i as b}from"./index-CRyfxVlp.js";import{i as v}from"./index-Bwv5fkBO.js";import{m as q}from"./index-DADV4aVQ.js";import{c as m}from"./index-BtXwjIh0.js";const _=(d,t,c)=>{const{ignoreUrls:u=[]}=c||{},h=window.fetch;return window.fetch=async function(a,r){let o;if(H(a)?o=a:v(a)?o=a.toString():o=a.url,u.length&&q(o,u))return h.call(this,a,r);const n=r?.method||"GET",e={};r?.headers&&(b(r.headers)?r.headers.forEach((s,i)=>{e[i]=s}):y(r.headers)?r.headers.forEach(([s,i])=>{e[s]=i}):Object.assign(e,r.headers));const l=performance.now();try{const s=await h.call(this,a,r),i=performance.now(),p=i-l,w=s.clone();let f=0;try{f=(await w.blob()).size}catch{}const g=s.ok,R={url:o,method:n,headers:e,body:r?.body,startTime:l,endTime:i,duration:p,status:s.status,responseSize:f,success:g};return d(R),!g&&t&&t({type:"fetch",message:`Fetch Error: ${s.status} ${s.statusText}`,timestamp:Date.now(),pageUrl:window.location.href,userAgent:navigator.userAgent,requestUrl:o,method:n,status:s.status,duration:p}),s}catch(s){const p=performance.now()-l;throw t&&t({type:"fetch",message:s instanceof Error?s.message:`Fetch Network Error: ${o}`,timestamp:Date.now(),pageUrl:window.location.href,userAgent:navigator.userAgent,requestUrl:o,method:n,duration:p}),s}},()=>{window.fetch=h}},T=(d,t,c)=>{const{ignoreUrls:u=[],timeoutThreshold:h=3e4}=c||{},a=XMLHttpRequest.prototype.open,r=XMLHttpRequest.prototype.send,o=XMLHttpRequest.prototype.setRequestHeader;return XMLHttpRequest.prototype.open=function(n,e,l,s,i){const p=typeof e=="string"?e:e.toString();return this.__surveillance__={method:n,url:p,headers:{},startTime:0},a.call(this,n,e,l??!0,s??null,i??null)},XMLHttpRequest.prototype.setRequestHeader=function(n,e){return this.__surveillance__&&(this.__surveillance__.headers[n]=e),o.call(this,n,e)},XMLHttpRequest.prototype.send=function(n){const e=this.__surveillance__;return e?u.length&&q(e.url,u)?r.call(this,n):(e.startTime=performance.now(),e.body=n,m(this,"loadend",()=>{const l=performance.now(),s=l-e.startTime,i=this.status>=200&&this.status<300,p={url:e.url,method:e.method,headers:e.headers,body:e.body,startTime:e.startTime,endTime:l,duration:s,status:this.status,responseSize:this.response?new Blob([this.response]).size:0,success:i};d(p),!i&&t&&t({type:"ajax",message:`XHR Error: ${this.status} ${this.statusText}`,timestamp:Date.now(),pageUrl:window.location.href,userAgent:navigator.userAgent,requestUrl:e.url,method:e.method,status:this.status,response:typeof this.response=="string"?this.response.slice(0,1e3):void 0,duration:s})}),m(this,"timeout",()=>{t&&t({type:"ajax",message:`XHR Timeout: ${e.url}`,timestamp:Date.now(),pageUrl:window.location.href,userAgent:navigator.userAgent,requestUrl:e.url,method:e.method,duration:h})}),m(this,"error",()=>{t&&t({type:"ajax",message:`XHR Network Error: ${e.url}`,timestamp:Date.now(),pageUrl:window.location.href,userAgent:navigator.userAgent,requestUrl:e.url,method:e.method})}),r.call(this,n)):r.call(this,n)},()=>{XMLHttpRequest.prototype.open=a,XMLHttpRequest.prototype.send=r,XMLHttpRequest.prototype.setRequestHeader=o}};class D{stoppers=[];requests=[];onRequest;onError;options;constructor(t={}){this.options=t,this.onRequest=t.onRequest,this.onError=t.onError}handleRequest=t=>{this.requests.push(t),this.onRequest?.(t)};observeXHR=()=>{const t=T(this.handleRequest,this.onError,this.options);return this.stoppers.push(t),t};observeFetch=()=>{const t=_(this.handleRequest,this.onError,this.options);return this.stoppers.push(t),t};observeAll=()=>{const t=this.observeXHR(),c=this.observeFetch();return()=>{t(),c()}};getStats=()=>{const t=this.requests.length;let c=0,u=0,h=0,a=0;const r={};for(const o of this.requests)o.success?c++:u++,h+=o.duration||0,(o.duration||0)>3e3&&a++,o.status&&(r[o.status]=(r[o.status]||0)+1);return{total:t,success:c,failed:u,totalDuration:h,avgDuration:t>0?h/t:0,slowRequests:a,byStatus:r}};getRequests=()=>[...this.requests];clear=()=>{this.requests.length=0};stop=()=>{this.stoppers.forEach(t=>t()),this.stoppers.length=0}}export{D as R};
