import{j as m}from"./jsx-runtime-u17CrQMm.js";/* empty css              */import{c as k}from"./index-Drfktd3g.js";import{s as i}from"./index-BvINh1mj.js";const f=(s,e)=>{const{priorityGroups:r,sortedPriorities:t}=s,a=e.priority??1/0,c=r.get(a);c?c.push(e):(r.set(a,[e]),w(t,a))},w=(s,e)=>{let r=0,t=s.length;for(;r<t;){const a=Math.floor((r+t)/2);s[a]<e?r=a+1:t=a}s.splice(r,0,e)};class T{maxConcurrency;runningTasks=new Map;isProcessing=!1;taskAddedNotifier=null;constructor(e=3){this.maxConcurrency=e}processQueue=async(e,r)=>{if(this.isProcessing){this.notifyTaskAdded();return}for(this.isProcessing=!0;this.hasTasksToProcess(e)||this.runningTasks.size>0;)this.startNewTasks(e,r),this.runningTasks.size!==0&&await this.waitForAnyTaskCompletionOrNewTask();this.isProcessing=!1};hasTasksToProcess=e=>{const{priorityGroups:r}=e;for(const t of r.values())if(t.length>0)return!0;return!1};startNewTasks=(e,r)=>{for(;this.runningTasks.size<this.maxConcurrency;){const t=this.getNextTask(e);if(!t)break;this.startTask(t,r)}};getNextTask=e=>{const{priorityGroups:r,sortedPriorities:t}=e;for(const a of t){const c=r.get(a);if(!c||c.length===0)continue;const l=c.shift();if(c.length!==0)return l;r.delete(a);const y=t.indexOf(a);return y>-1&&t.splice(y,1),l}return null};startTask=async(e,r)=>{const{name:t,loadFn:a,priority:c=1/0}=e,l=this.createTaskPromise(t,a,r),y={name:t,priority:c,promise:l};this.runningTasks.set(t,y),await l,this.runningTasks.delete(t)};createTaskPromise=async(e,r,t)=>{const a=await r();t[e].current=a,t[e].resolve()};waitForAnyTaskCompletionOrNewTask=async()=>{if(this.runningTasks.size===0)return;const e=Array.from(this.runningTasks.values()).map(t=>t.promise),r=new Promise(t=>{this.taskAddedNotifier=t});await Promise.race([...e,r]),this.taskAddedNotifier=null};notifyTaskAdded=()=>{this.taskAddedNotifier?.()};getStatus=()=>({maxConcurrency:this.maxConcurrency,runningCount:this.runningTasks.size,runningTasks:Array.from(this.runningTasks.values()).map(e=>({name:e.name,priority:e.priority})),isProcessing:this.isProcessing});setMaxConcurrency=e=>{this.maxConcurrency=Math.max(1,e)}}class h{resourceMap={};queue={priorityGroups:new Map,sortedPriorities:[]};queueProcessor;isAutoProcess=!1;constructor(e={}){const{maxConcurrency:r=3}=e;this.queueProcessor=new T(r)}add=e=>{this.addToQueue(e)};load=async()=>{await this.queueProcessor.processQueue(this.queue,this.resourceMap)};addAndLoadImmediately=async e=>{this.addToQueue(e),await this.queueProcessor.processQueue(this.queue,this.resourceMap)};enableAutoProcess=()=>{this.isAutoProcess=!0};disableAutoProcess=()=>{this.isAutoProcess=!1};addToQueue=async e=>{const{name:r}=e;this.resourceMap[r]||(f(this.queue,e),this.resourceMap[r]=k(),this.isAutoProcess&&this.queueProcessor.processQueue(this.queue,this.resourceMap))};getStatus=()=>{const e=this.queueProcessor.getStatus(),r=Array.from(this.queue.priorityGroups.values()).reduce((a,c)=>a+c.length,0),t=this.queue.sortedPriorities.slice();return{...e,totalPending:r,totalPriorities:t,totalResources:Object.keys(this.resourceMap).length,isAutoProcess:this.isAutoProcess}};setMaxConcurrency=e=>{this.queueProcessor.setMaxConcurrency(e)};reset=()=>{this.queue={priorityGroups:new Map,sortedPriorities:[]},this.resourceMap={},this.isAutoProcess=!1}}const{action:u}=__STORYBOOK_MODULE_ACTIONS__,P=async()=>{const s=new h({maxConcurrency:2});s.add({name:"resource1",loadFn:async()=>{try{return u("开始加载资源1")(),await i(2e3),u("资源1加载完成")(),"resource1 loaded"}catch(r){return`resource1 failed: ${r.message}`}}}),u("添加资源1 优先级无")(),s.add({name:"resource2",loadFn:async()=>{try{return u("开始加载资源2")(),await i(2e3),u("资源2加载完成")(),"resource2 loaded"}catch(r){return`resource2 failed: ${r.message}`}},priority:1}),u("添加资源2 优先级1")(),s.add({name:"resource3",loadFn:async()=>{try{return u("开始加载资源3")(),await i(2e3),u("资源3加载完成")(),"resource3 loaded"}catch(r){return`resource3 failed: ${r.message}`}},priority:2}),u("添加资源3 优先级2")(),u("开始加载资源 最大并发2")(),await s.load();const e={resource1:s.resourceMap.resource1.current,resource2:s.resourceMap.resource2.current,resource3:s.resourceMap.resource3.current};u("加载完成, 结果:")(e)},{action:d}=__STORYBOOK_MODULE_ACTIONS__,M=async()=>{const s=new h({maxConcurrency:2});d("创建 ResourceController 最大并发2")(),d("添加紧急资源并立即加载 优先级0")(),await s.addAndLoadImmediately({name:"urgent-resource",loadFn:async()=>{try{return d("开始加载紧急资源")(),await i(2e3),d("紧急资源加载完成")(),"urgent resource loaded immediately"}catch(r){return`urgent resource failed: ${r.message}`}},priority:0}),d("紧急资源外部等待加载完成")(),d("添加普通资源并立即加载 优先级2")(),await s.addAndLoadImmediately({name:"normal-resource",loadFn:async()=>{try{return d("开始加载普通资源")(),await i(2e3),d("普通资源加载完成")(),"normal resource loaded"}catch(r){return`normal resource failed: ${r.message}`}},priority:2}),d("普通资源外部等待加载完成")();const e={urgent:s.resourceMap["urgent-resource"].current,normal:s.resourceMap["normal-resource"].current};d("所有资源加载完成, 结果:")({results:e,status:s.getStatus()})},{action:n}=__STORYBOOK_MODULE_ACTIONS__,A=async()=>{const s=new h({maxConcurrency:2});n("创建 ResourceController 最大并发2")(),s.enableAutoProcess(),n("启用自动处理模式")(),s.add({name:"auto-task-1",loadFn:async()=>{try{return n("开始加载自动任务1")(),await i(1e4),n("自动任务1加载完成")(),"Auto task 1 completed"}catch(r){return`auto task 1 failed: ${r.message}`}},priority:1}),n("添加自动任务1 优先级1")(),await i(5e3),s.add({name:"auto-task-2",loadFn:async()=>{try{return n("开始加载自动任务2")(),await i(1e4),n("自动任务2加载完成")(),"Auto task 2 completed"}catch(r){return`auto task 2 failed: ${r.message}`}},priority:2}),n("添加自动任务2 优先级2")(),s.add({name:"auto-task-3",loadFn:async()=>{try{return n("开始加载自动任务3")(),await i(1e4),n("自动任务3加载完成")(),"Auto task 3 completed"}catch(r){return`auto task 3 failed: ${r.message}`}},priority:3}),n("添加自动任务3 优先级3")(),await i(2e3),s.add({name:"urgent-task",loadFn:async()=>{try{return n("开始加载紧急任务")(),await i(1e4),n("紧急任务加载完成")(),"Urgent task completed"}catch(r){return`urgent task failed: ${r.message}`}},priority:0}),n("添加紧急任务 优先级0 (会立即开始执行，与任务1并发)")(),await Promise.all([s.resourceMap["auto-task-1"].promise,s.resourceMap["auto-task-2"].promise,s.resourceMap["auto-task-3"].promise,s.resourceMap["urgent-task"].promise]);const e={"auto-task-1":s.resourceMap["auto-task-1"].current,"auto-task-2":s.resourceMap["auto-task-2"].current,"auto-task-3":s.resourceMap["auto-task-3"].current,"urgent-task":s.resourceMap["urgent-task"].current};n("所有资源加载完成, 结果:")(e)},{action:o}=__STORYBOOK_MODULE_ACTIONS__,C=async()=>{const s=new h;o("创建 ResourceController 默认并发3")(),s.add({name:"low-priority",loadFn:async()=>{try{return o("开始加载低优先级资源")(),await i(1e4),o("低优先级资源加载完成")(),"Low priority resource loaded"}catch(r){return`low priority failed: ${r.message}`}},priority:3}),o("添加低优先级资源 优先级3")(),s.add({name:"high-priority",loadFn:async()=>{try{return o("开始加载高优先级资源")(),await i(1e4),o("高优先级资源加载完成")(),"High priority resource loaded"}catch(r){return`high priority failed: ${r.message}`}},priority:1}),o("添加高优先级资源 优先级1")(),s.add({name:"medium-priority-1",loadFn:async()=>{try{return o("开始加载中等优先级资源1")(),await i(1e4),o("中等优先级资源1加载完成")(),"Medium priority resource 1 loaded"}catch(r){return`medium priority 1 failed: ${r.message}`}},priority:2}),o("添加中等优先级资源1 优先级2")(),s.add({name:"medium-priority-2",loadFn:async()=>{try{return o("开始加载中等优先级资源2")(),await i(1e4),o("中等优先级资源2加载完成")(),"Medium priority resource 2 loaded"}catch(r){return`medium priority 2 failed: ${r.message}`}},priority:2}),o("添加中等优先级资源2 优先级2")(),s.add({name:"no-priority",loadFn:async()=>{try{return o("开始加载无优先级资源")(),await i(1e4),o("无优先级资源加载完成")(),"No priority resource loaded"}catch(r){return`no priority failed: ${r.message}`}}}),o("添加无优先级资源 优先级无")(),o("开始按优先级加载所有资源")(),await s.load();const e={"high-priority":s.resourceMap["high-priority"].current,"medium-priority-1":s.resourceMap["medium-priority-1"].current,"medium-priority-2":s.resourceMap["medium-priority-2"].current,"low-priority":s.resourceMap["low-priority"].current,"no-priority":s.resourceMap["no-priority"].current};o("优先级加载完成, 结果:")(e)},g=()=>m.jsxs("div",{children:[m.jsx("div",{className:"button",onClick:P,children:"基础用法演示"}),m.jsx("div",{className:"button",onClick:M,children:"立即加载演示"}),m.jsx("div",{className:"button",onClick:C,children:"优先级队列演示"}),m.jsx("div",{className:"button",onClick:A,children:"自动处理模式演示"})]});g.__docgenInfo={description:"",methods:[],displayName:"ResourceControllerDemo"};const F={title:"js-utils/resource-controller",component:g,parameters:{layout:"centered"},argTypes:{}},p={};p.parameters={...p.parameters,docs:{...p.parameters?.docs,source:{originalSource:"{}",...p.parameters?.docs?.source}}};const $=["Demo"];export{p as Demo,$ as __namedExportsOrder,F as default};
