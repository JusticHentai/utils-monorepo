import{j as m}from"./jsx-runtime-u17CrQMm.js";import{r as f}from"./iframe-BWchUvSv.js";/* empty css              */import"./preload-helper-PPVm8Dsz.js";const _=e=>{const{initialTime:t,initialFrame:i,duration:a,frameCount:n}=e,r=Date.now()-t,s=Math.floor(r/(a/n))+i,c=s%n,o=Math.floor(s/n);return{nextFrame:c,completedTimes:o}},w=e=>{const{canvas:t,frameBitmap:i,width:a,height:n}=e,r=t.getContext("2d");r.clearRect(0,0,a,n),r.drawImage(i,0,0,a,n)};class F{options;initialTime=0;initialFrame=0;currentFrame=-1;currentTimes=0;rafId;totalTimes=-1;constructor(t){this.options=t}start=t=>{this.rafId&&cancelAnimationFrame(this.rafId),this.initialTime=Date.now(),this.initialFrame=0,this.currentFrame=-1,this.currentTimes=0,this.totalTimes=t??-1,this.rafId=requestAnimationFrame(this.render)};resume=()=>{this.rafId&&cancelAnimationFrame(this.rafId),this.initialTime=Date.now(),this.initialFrame=this.currentFrame,this.rafId=requestAnimationFrame(this.render)};pause=()=>{this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0)};render=()=>{const{frameCount:t,duration:i,canvasEl:a,frameList:n,width:r,height:s}=this.options,{currentFrame:c,initialFrame:o,initialTime:h,totalTimes:d}=this,{nextFrame:l,completedTimes:p}=_({initialFrame:o,initialTime:h,duration:i,frameCount:t});if(!n[l]){this.rafId=requestAnimationFrame(this.render);return}if(l===c){this.rafId=requestAnimationFrame(this.render);return}if(p!==this.currentTimes&&this.options.onCompleteOnce?.(this.currentTimes),d>0&&p>=d){this.options.onComplete?.(),this.pause();return}w({canvas:a,frameBitmap:n[l],width:r,height:s}),this.currentFrame=l,this.currentTimes=p,this.options.onFrame?.(l),this.rafId=requestAnimationFrame(this.render)}}const x=e=>{const{imageElement:t,frameCount:i,rowCount:a}=e,n=Math.ceil(i/a),r=t.width/n,s=t.height/a,c=[];for(let o=0;o<i;o++){const h=o%n*r,d=Math.floor(o/n)*s;c.push({left:h,top:d})}return{width:r,height:s,frameList:c}},I=e=>{const{height:t,width:i,canvas:a}=e;a.style.height=`${t}px`,a.style.width=`${i}px`;const n=window.devicePixelRatio||1;a.height=t*n,a.width=i*n,a.getContext("2d").scale(n,n)},O=async e=>{const{width:t,height:i,left:a,top:n,imageEl:r}=e;return createImageBitmap(r,a,n,t,i)},C=e=>new Promise(t=>{const i=new Image;i.crossOrigin="anonymous",i.src=e,i.onload=()=>t(i),i.onerror=()=>t(void 0)});class T{options;imageElement;frameState={width:0,height:0};frameList=[];constructor(t){this.options=t}preRender=async()=>{const t=await this.loadImage();if(!t)return;const{frameCount:i,rowCount:a}=this.options,{width:n,height:r,frameList:s}=x({imageElement:t,frameCount:i,rowCount:a});this.frameState={width:n,height:r};const c=await Promise.all(s.map(o=>O({width:n,height:r,left:o.left,top:o.top,imageEl:t})));this.frameList=s.map((o,h)=>({bitmap:c[h],...o}))};createInstance=t=>{const{width:i,height:a}=t.getBoundingClientRect(),n=document.createElement("canvas");I({width:i,height:a,canvas:n}),t.appendChild(n);const r=this.frameList.map(s=>s.bitmap);return new F({...this.options,canvasEl:n,width:i,height:a,frameList:r})};loadImage=async()=>(this.imageElement=await C(this.options.imageUrl),this.imageElement)}const A=""+new URL("frameAnimationDemo-_k5Gzj6b.png",import.meta.url).href,{action:v}=__STORYBOOK_MODULE_ACTIONS__,R=async()=>{const e=new T({imageUrl:A,frameCount:20,duration:2e3,rowCount:4});return await e.preRender(),v("创建 FrameAnimation 实例")({message:"已创建 FrameAnimation 实例",methods:["preRender","createInstance","loadImage"],frameList:e.frameList.map(t=>({type:t.bitmap.constructor.name,width:t.bitmap.width,height:t.bitmap.height}))}),{animation:e}},{action:D}=__STORYBOOK_MODULE_ACTIONS__,y=e=>{e?.start(),D("开始播放")("循环播放")},{action:E}=__STORYBOOK_MODULE_ACTIONS__,L=e=>{e?.start(1),E("播放一次")("播放 1 次")},{action:S}=__STORYBOOK_MODULE_ACTIONS__,b=e=>{e?.pause(),S("暂停")("已暂停")},{action:j}=__STORYBOOK_MODULE_ACTIONS__,N=e=>{e?.resume(),j("继续")("继续播放")},g=()=>{const e=f.useRef(null),t=f.useRef(null),i=async()=>{if(!e.current)return;const c=await R();e.current.innerHTML="",t.current=c.animation.createInstance(e.current)},a=()=>{y(t.current)},n=()=>{L(t.current)},r=()=>{b(t.current)},s=()=>{N(t.current)};return m.jsxs("div",{style:{display:"flex",height:"100vh"},children:[m.jsx("div",{style:{height:"100%",aspectRatio:"134 / 180",background:"#1a1f3c",flexShrink:0},children:m.jsx("div",{ref:e,style:{width:"100%",height:"100%"}})}),m.jsxs("div",{style:{display:"flex",gap:8,padding:16,flexWrap:"wrap",alignItems:"center",alignContent:"center"},children:[m.jsx("div",{className:"button",onClick:i,children:"创建实例"}),m.jsx("div",{className:"button",onClick:a,children:"循环播放"}),m.jsx("div",{className:"button",onClick:n,children:"播放一次"}),m.jsx("div",{className:"button",onClick:r,children:"暂停"}),m.jsx("div",{className:"button",onClick:s,children:"继续"})]})]})};g.__docgenInfo={description:"",methods:[],displayName:"FrameAnimationDemo"};const $={title:"element-utils/FrameAnimation",component:g,parameters:{layout:"fullscreen"},argTypes:{}},u={};u.parameters={...u.parameters,docs:{...u.parameters?.docs,source:{originalSource:"{}",...u.parameters?.docs?.source}}};const q=["Demo"];export{u as Demo,q as __namedExportsOrder,$ as default};
